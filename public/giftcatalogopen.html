<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ギフトをえらぶ | えらべるギフト</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #f1ece8;
      --ink: #2b2b2b;
      --muted: #7a7268;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --card-w: min(340px, 82vw);
    }

    *{ box-sizing:border-box; }

    /* ▼ フェードイン ▼ */
    body{
      margin:0;
      background:var(--bg);
      font-family:"Noto Sans JP","Hiragino Sans","-apple-system",system-ui,sans-serif;
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      opacity:0;
      transition: opacity .9s ease;
    }
    body.is-visible{
      opacity:1;
    }
    /* ▲ フェードイン ▲ */

    .app{
      max-width:480px;
      margin:0 auto;
      padding:24px 16px calc(24px + var(--safe-bottom));
    }

    .header{
      text-align:center;
      margin-bottom:28px;
    }

    .title{
      font-size:26px;
      letter-spacing:.16em;
      text-transform:uppercase;
      font-weight:700;
    }

    .caption{
      margin-top:6px;
      font-size:11px;
      letter-spacing:.1em;
      text-transform:uppercase;
      color:var(--muted);
    }

    /* ===== カルーセル ===== */
    .bleed{
      width:100vw;
      margin-left:50%;
      transform:translateX(-50%);
    }

    .gift-wrap{
      margin-top:12px;
    }

    .gift-list{
      display:flex;
      gap:18px;
      overflow-x:auto;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
      padding:8px 0 22px;
      scrollbar-width:none;
    }
    .gift-list::-webkit-scrollbar{ display:none; }

    .gift-list::before,
    .gift-list::after{
      content:"";
      flex:0 0 calc((100vw - var(--card-w)) / 2);
    }

    .gift-item{
      flex:0 0 var(--card-w);
      scroll-snap-align:center;
      cursor:pointer;
      transition:opacity .12s ease, transform .12s ease;
    }
    .gift-item.selected{
      transform:translateY(-3px);
    }

    .photo-frame{
      width:100%;
      aspect-ratio:1 / 1;
      display:flex;
      align-items:center;
      justify-content:center;
      background:transparent;
      border:none;
      overflow:visible;
      position:relative;
    }
    .photo-frame img{
      width:86%;
      height:86%;
      object-fit:cover;
      background:#fff;
      border:1px solid #111;
      box-sizing:border-box;
      display:block;
      filter:
        saturate(0.9)
        contrast(0.85)
        brightness(1.03);
    }
    .photo-frame::after{
      content:"";
      position:absolute;
      inset:7%;
      pointer-events:none;
      mix-blend-mode:soft-light;
      opacity:.6;
      background-image:
        radial-gradient(circle at 0 0, rgba(0,0,0,.18) 0, transparent 55%),
        radial-gradient(circle at 100% 0, rgba(0,0,0,.12) 0, transparent 55%),
        radial-gradient(circle at 0 100%, rgba(0,0,0,.14) 0, transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(0,0,0,.16) 0, transparent 55%);
      background-size:18px 18px;
    }

    .info{ margin-top:10px; }

    .gift-name{
      font-size:15px;
      font-weight:600;
      margin-bottom:12px;
    }

    .gift-meta{
      font-size:12px;
      color:var(--muted);
      letter-spacing:.04em;
      margin-bottom:2px;
    }

    .gift-note{
      font-size:12px;
      color:#4a433b;
      line-height:1.6;
      margin-top:4px;
      margin-bottom:12px;
    }

    .detail-wrap{
      text-align:center;
      margin-top:12px;
    }
    .btn-secondary{
      border:none;
      background:none;
      padding:4px 0;
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#2b2b2b;
      cursor:pointer;
    }
    .btn-secondary:active{ transform:translateY(1px); }

    .detail-divider{
      width:46%;
      height:1px;
      margin:4px auto 0;
      background:linear-gradient(
        90deg,
        rgba(0,0,0,.02),
        rgba(0,0,0,.20),
        rgba(0,0,0,.02)
      );
    }

    .pager{
      margin-top:16px;
      display:flex;
      justify-content:center;
      gap:8px;
    }
    .pager-dot{
      width:6px;
      height:6px;
      border-radius:50%;
      background:#d3c9c0;
      transition:transform .12s ease, background-color .12s ease;
    }
    .pager-dot.is-active{
      background:#2b2b2b;
      transform:scale(1.35);
    }

    /* ===== モーダル ===== */
    body.is-modal-open{ overflow:hidden; }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 16px;
      opacity:0;
      pointer-events:none;
      transition:opacity .22s ease;
      z-index:40;
    }
    .modal-backdrop.is-open{
      opacity:1;
      pointer-events:auto;
    }

    .modal-dialog{
      max-width:360px;
      width:100%;
      background:#f9f4ee;
      border-radius:18px;
      box-shadow:0 18px 40px rgba(0,0,0,.22);
      padding:18px 18px 20px;
      position:relative;
    }
    .modal-close{
      position:absolute;
      top:10px;
      right:10px;
      border:none;
      background:transparent;
      font-size:18px;
      line-height:1;
      cursor:pointer;
      color:#766a5f;
    }
    .modal-name{
      font-size:15px;
      font-weight:600;
      margin-bottom:8px;
    }
    .modal-short{
      font-size:13px;
      line-height:1.7;
      color:#4a433b;
      margin-bottom:10px;
    }
    .modal-separator{
      height:1px;
      width:100%;
      background:linear-gradient(90deg, rgba(0,0,0,.06), rgba(0,0,0,.18), rgba(0,0,0,.06));
      margin:8px 0 12px;
    }
    .modal-long{
      font-size:13px;
      line-height:1.8;
      color:#4a433b;
      margin-bottom:16px;
      white-space:pre-wrap;
    }
    .modal-footer{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:4px;
    }
    .btn-primary{
      flex:1;
      background:#000;
      color:#fff;
      border:none;
      border-radius:999px;
      padding:13px;
      font-size:14px;
      font-weight:600;
      letter-spacing:.14em;
      text-transform:uppercase;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(0,0,0,.16);
    }
    .btn-primary:active{ transform:translateY(1px); }

    .btn-outline{
      flex:1;
      background:#f9f4ee;
      color:#2b2b2b;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.16);
      padding:11px;
      font-size:13px;
      letter-spacing:.08em;
      text-transform:uppercase;
      cursor:pointer;
    }
    .btn-outline:active{ transform:translateY(1px); }

    .confirm-title{
      font-size:15px;
      font-weight:600;
      margin-bottom:8px;
      text-align:center;
    }
    .confirm-text{
      font-size:13px;
      line-height:1.7;
      color:#4a433b;
      margin-bottom:16px;
      text-align:center;
    }
  </style>
</head>
<body>

  <div class="app">
    <header class="header">
      <div class="title">SELECT A GIFT</div>
      <div class="caption">CHOOSE ONE FROM THREE</div>
    </header>

    <main class="gift-wrap bleed">
      <div class="gift-list" id="giftList">

        <!-- A/B/C の中身はダミー。JSで上書きされます -->
        <div class="gift-item" data-id="1">
          <div class="photo-frame">
            <img src="" alt="">
          </div>
          <div class="info">
            <div class="gift-name"></div>
            <div class="gift-meta">選んだ理由</div>
            <div class="gift-note"></div>
            <div class="detail-wrap">
              <button class="btn-secondary detail-button" type="button">詳細を見る</button>
              <div class="detail-divider"></div>
            </div>
          </div>
        </div>

        <div class="gift-item" data-id="2">
          <div class="photo-frame">
            <img src="" alt="">
          </div>
          <div class="info">
            <div class="gift-name"></div>
            <div class="gift-meta">選んだ理由</div>
            <div class="gift-note"></div>
            <div class="detail-wrap">
              <button class="btn-secondary detail-button" type="button">詳細を見る</button>
              <div class="detail-divider"></div>
            </div>
          </div>
        </div>

        <div class="gift-item" data-id="3">
          <div class="photo-frame">
            <img src="" alt="">
          </div>
          <div class="info">
            <div class="gift-name"></div>
            <div class="gift-meta">選んだ理由</div>
            <div class="gift-note"></div>
            <div class="detail-wrap">
              <button class="btn-secondary detail-button" type="button">詳細を見る</button>
              <div class="detail-divider"></div>
            </div>
          </div>
        </div>

      </div>
    </main>

    <div class="pager">
      <span class="pager-dot is-active" data-id="1"></span>
      <span class="pager-dot" data-id="2"></span>
      <span class="pager-dot" data-id="3"></span>
    </div>

    <!-- 詳細モーダル -->
    <div class="modal-backdrop" id="giftModal">
      <div class="modal-dialog">
        <button class="modal-close" type="button" data-role="close">×</button>

        <div class="modal-body">
          <div class="modal-name"></div>
          <div class="modal-short"></div>
          <div class="modal-separator"></div>
          <div class="modal-long"></div>
        </div>

        <div class="modal-footer">
          <button class="btn-primary" type="button" id="chooseButton">
            このギフトにする
          </button>
        </div>
      </div>
    </div>

    <!-- 確認モーダル -->
    <div class="modal-backdrop" id="confirmModal">
      <div class="modal-dialog">
        <button class="modal-close" type="button" data-role="confirm-close">×</button>

        <p class="confirm-title">このギフトでよろしいですか？</p>
        <p class="confirm-text">
          このギフトがプレゼントとして送られます。
        </p>

        <div class="modal-footer">
          <button class="btn-outline" type="button" id="confirmBack">
            まちがえたかも
          </button>
          <button class="btn-primary" type="button" id="confirmOk">
            これに決定する
          </button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // master（eraberuGift）のみ扱う
    function loadState(){
      try{
        return JSON.parse(localStorage.getItem("eraberuGift") || "{}");
      }catch(e){
        return {};
      }
    }
    function saveState(patch){
      const current = loadState();
      const next = Object.assign({}, current, patch || {});
      try{
        localStorage.setItem("eraberuGift", JSON.stringify(next));
      }catch(e){}
    }

    // 現在の URL から "id"（カタログID）と "preview" だけを持ち回す
    const baseParams = (() => {
      const src = new URLSearchParams(location.search);
      const dst = new URLSearchParams();
      const keepKeys = ["id","preview"];
      keepKeys.forEach(k=>{
        const v = src.get(k);
        if (v !== null) dst.set(k, v);
      });
      return dst;
    })();

    const previewRaw = baseParams.get("preview");
    const isPreview =
      previewRaw === "1" || previewRaw === "true";

    window.addEventListener("DOMContentLoaded", () => {
      requestAnimationFrame(() => {
        document.body.classList.add("is-visible");
      });
      initGiftPage();
    });

    function initGiftPage(){
      const state = loadState();

      const items  = Array.from(document.querySelectorAll(".gift-item"));
      const listEl = document.getElementById("giftList");
      const dots   = Array.from(document.querySelectorAll(".pager-dot"));

      // URL→perUrl のキー解決
      function getUrlForIndex(index){
        const candidates = ["url"+index, "link"+index, "productUrl"+index];
        for (const key of candidates){
          const v = state[key];
          if (typeof v === "string" && v.trim()){
            return v.trim();
          }
        }
        return "";
      }

      function getPerUrlEntry(index){
        if (!state.perUrl || typeof state.perUrl !== "object") return null;
        const url    = getUrlForIndex(index);
        const urlKey = url || ("slot" + index);
        const entry  = state.perUrl[urlKey];
        return entry || null;
      }

      const modal         = document.getElementById("giftModal");
      const modalNameEl   = modal.querySelector(".modal-name");
      const modalShortEl  = modal.querySelector(".modal-short");
      const modalLongEl   = modal.querySelector(".modal-long");
      const modalCloseBtn = modal.querySelector("[data-role='close']");
      const chooseButton  = document.getElementById("chooseButton");

      const confirmModal   = document.getElementById("confirmModal");
      const confirmClose   = confirmModal.querySelector("[data-role='confirm-close']");
      const confirmBackBtn = document.getElementById("confirmBack");
      const confirmOkBtn   = document.getElementById("confirmOk");

      let selectedId     = "1";   // UI 上の現在選択中カード
      let modalCurrentId = null;  // モーダルで「このギフトにする」を押そうとしているカード

      // プレビュー時は文言差し替え
      if (isPreview){
        const titleEl = confirmModal.querySelector(".confirm-title");
        const textEl  = confirmModal.querySelector(".confirm-text");
        if (titleEl) titleEl.textContent = "お相手はこのように受け取ります。";
        if (textEl)  textEl.textContent  = "プレビューを終了しますか？";
        if (confirmOkBtn) confirmOkBtn.textContent = "終了する";
      }

      // master → UI 反映（三枚とも 1,2,3 で確実に分かれるように index を使う）
      items.forEach(item => {
        const idStr = item.dataset.id;
        const idx   = parseInt(idStr,10);

        const per = getPerUrlEntry(idx);

        const giftName =
          state[`gift${idx}Name`] ||
          (per && per.title)     ||
          state[`title${idx}`]   ||
          "";

        const giftReason =
          state[`gift${idx}Reason`] ||
          state[`reason${idx}`]     ||
          (state.reasons && state.reasons[`reason${idx}`]) ||
          "";

        const productDesc =
          (per && per.desc)   ||
          state[`desc${idx}`] ||
          "";

        const giftImg =
          state[`gift${idx}Img`] ||
          (per && per.imgData)  ||
          "";

        const nameEl = item.querySelector(".gift-name");
        const noteEl = item.querySelector(".gift-note");
        const imgEl  = item.querySelector(".photo-frame img");

        if (nameEl) nameEl.textContent = giftName || "";
        if (noteEl) noteEl.textContent = giftReason || "";
        if (imgEl && giftImg){
          imgEl.src = giftImg;
          imgEl.alt = giftName || ("ギフト" + idx);
        }

        // 後でモーダルに渡すため data-* にも保持しておく
        item.dataset.name   = giftName || "";
        item.dataset.reason = giftReason || "";
        item.dataset.desc   = productDesc || "";
        item.dataset.img    = giftImg || "";
      });

      function updateCards(){
        items.forEach(item=>{
          item.classList.toggle("selected", item.dataset.id === selectedId);
        });
      }

      function updateDots(){
        dots.forEach(dot=>{
          dot.classList.toggle("is-active", dot.dataset.id === selectedId);
        });
      }

      function setSelected(id, options){
        options = options || {};
        if (id === selectedId) return;
        selectedId = id;
        updateCards();
        updateDots();

        if (options.scroll){
          const target = items.find(it => it.dataset.id === id);
          if (target){
            target.scrollIntoView({
              behavior: options.behavior || "smooth",
              inline: "center",
              block: "nearest"
            });
          }
        }
      }

      // カードタップ → 詳細モーダルを開く
      items.forEach(item=>{
        item.addEventListener("click", ()=>{
          openModalFromItem(item);
        });
      });

      // 「詳細を見る」ボタン（カードクリックとは別に stopPropagation）
      document.querySelectorAll(".detail-button").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          e.stopPropagation();
          const item = btn.closest(".gift-item");
          if(!item) return;
          openModalFromItem(item);
        });
      });

      // ページャードット
      dots.forEach(dot=>{
        dot.addEventListener("click", ()=>{
          setSelected(dot.dataset.id, { scroll:true, behavior:"smooth" });
        });
      });

      // スクロール位置から「中央のカード」を選択状態に
      let timer;
      listEl.addEventListener("scroll", ()=>{
        clearTimeout(timer);
        timer = setTimeout(()=>{
          const centerX = listEl.getBoundingClientRect().left + listEl.clientWidth/2;
          let bestId   = selectedId;
          let bestDist = Infinity;

          items.forEach(item=>{
            const r   = item.getBoundingClientRect();
            const mid = r.left + r.width/2;
            const d   = Math.abs(mid - centerX);
            if(d < bestDist){
              bestDist = d;
              bestId   = item.dataset.id;
            }
          });

          if(bestId !== selectedId){
            selectedId = bestId;
            updateCards();
            updateDots();
          }
        }, 80);
      });

      // カード → 詳細モーダルへ
      function openModalFromItem(item){
        const id   = item.dataset.id;
        const name = item.dataset.name || item.querySelector(".gift-name")?.textContent || "";
        const reasonText = item.dataset.reason || "";
        const descText   = item.dataset.desc   || "";
        const imgSrc     = item.dataset.img    || item.querySelector(".photo-frame img")?.src || "";

        selectedId = id;
        updateCards();
        updateDots();

        modalNameEl.textContent  = name;
        modalShortEl.textContent = reasonText;
        modalLongEl.textContent  = descText;

        // どのギフトかをモーダルに保持（ここが次ページに渡す「真実の値」）
        modal.dataset.id   = id;
        modal.dataset.name = name;
        modal.dataset.img  = imgSrc;

        modal.classList.add("is-open");
        document.body.classList.add("is-modal-open");
        modalCurrentId = id;
      }

      function closeDetailModal(){
        modal.classList.remove("is-open");
        modalCurrentId = null;
        delete modal.dataset.id;
        delete modal.dataset.name;
        delete modal.dataset.img;

        if (!confirmModal.classList.contains("is-open")) {
          document.body.classList.remove("is-modal-open");
        }
      }

      modalCloseBtn.addEventListener("click", closeDetailModal);
      modal.addEventListener("click", (e)=>{
        if(e.target === modal){
          closeDetailModal();
        }
      });

      function openConfirmModal(){
        confirmModal.classList.add("is-open");
        document.body.classList.add("is-modal-open");
      }
      function closeConfirmModal(){
        confirmModal.classList.remove("is-open");
        if (!modal.classList.contains("is-open")) {
          document.body.classList.remove("is-modal-open");
        }
      }

      confirmClose.addEventListener("click", closeConfirmModal);
      confirmBackBtn.addEventListener("click", closeConfirmModal);
      confirmModal.addEventListener("click", (e)=>{
        if (e.target === confirmModal){
          closeConfirmModal();
        }
      });

      // 「このギフトにする」→ 確認モーダル
      chooseButton.addEventListener("click", ()=>{
        if(!modalCurrentId) return;
        openConfirmModal();
      });

      // 「これに決定する」 / 「終了する」
      confirmOkBtn.addEventListener("click", ()=>{
        if(!modalCurrentId) return;

        // ここで選択されたギフト ID / 名前 / 画像を一度ローカルに確定
        const chosenId   = modal.dataset.id   || modalCurrentId;  // "1" / "2" / "3"
        const chosenName = modal.dataset.name || "";
        const chosenImg  = modal.dataset.img  || "";

        if (isPreview){
          // プレビュー時：localStorage は触らず makelink.html に戻る
          const srcParams = new URLSearchParams(location.search);
          const base = location.pathname.replace(/[^\/]*$/, "");
          const backUrl = base + "makelink.html" + (srcParams.toString() ? "?" + srcParams.toString() : "");
          window.location.href = backUrl;
          return;
        }

        // 本番時：
        // ① master（eraberuGift）に選択結果を保存
        saveState({
          giftId: String(chosenId),            // 1 / 2 / 3
          selectedGiftIndex: String(chosenId), // 1 / 2 / 3
          selectedGiftName: chosenName || "",
          selectedGiftImg: chosenImg || ""
        });

        // ② 選択結果専用のキーにも（必要なら giftfinish で読みやすいように）
        try{
          localStorage.setItem(
            "eraberuGift_selected",
            JSON.stringify({
              giftId: String(chosenId),
              giftName: chosenName,
              giftImg: chosenImg
            })
          );
        }catch(e){
          console.error("selected 保存エラー", e);
        }

        // ③ URL クエリに giftId=1/2/3 を明示して次ページへ
        const nextParams = new URLSearchParams(baseParams.toString());
        nextParams.set("giftId", String(chosenId));   // ★ ここが次ページの index

        const qs = nextParams.toString();
        const base = location.pathname.replace(/[^\/]*$/, "");
        const nextUrl = base + "giftfinish.html" + (qs ? "?" + qs : "");
        window.location.href = nextUrl;
      });

      // 初期表示位置（PC は真ん中 / SP は1枚目）
      const isPC = window.matchMedia("(min-width: 768px)").matches;

      if(isPC && items[1]){
        items[1].scrollIntoView({
          behavior:"auto",
          inline:"center",
          block:"nearest"
        });
        selectedId = items[1].dataset.id;
        updateCards();
        updateDots();
      }else{
        const initial = items[0];
        if(initial){
          initial.scrollIntoView({
            behavior:"auto",
            inline:"center",
            block:"nearest"
          });
        }
        selectedId = initial ? initial.dataset.id : "1";
        updateCards();
        updateDots();
      }
    }
  </script>

</body>
</html>
