<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>商品情報の確認 | えらべるギフト</title>
<link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">

<style>
  :root{
    --pink:#f58fb1; --ink:#2a2a2a; --muted:#6b7280;
    --bg-top:#fff1f6; --bg-bottom:#fde9d3;
    --grad:linear-gradient(90deg,#f08db0 0%,#f2b35e 100%);
    --card-bg:#fff; --radius:18px;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --vh: 1svh;
    --screenH: calc(var(--vh) * 100);
    /* カードは細めに戻す */
    --card-h: clamp(310px, calc(var(--screenH) * 0.54), 500px);
    --card-w: clamp(220px, calc(var(--card-h) * 0.64), 320px);
  }

  *{box-sizing:border-box}
  html,body{min-height:100vh;height:auto}
  body{
    margin:0;
    font-family:"Kosugi Maru","Hiragino Maru Gothic ProN","Hiragino Sans","Noto Sans JP",system-ui,-apple-system,sans-serif;
    color:var(--ink);
    background: linear-gradient(180deg,var(--bg-top),var(--bg-bottom)) fixed;
    background-size: 100% 100%;
  }
  a{color:inherit;text-decoration:none}

  .wrap{
    max-width:960px; margin:0 auto; padding:16px 16px 0;
    min-height:var(--screenH);
    display:flex; flex-direction:column;
  }
  .main{flex:1; display:flex; flex-direction:column;}

  .header{display:flex;align-items:center;gap:12px;padding-top:4px;}
  .logo{width:32px;height:32px;display:flex;align-items:center;justify-content:center}
  .brand{font-weight:800;font-size:22px;color:var(--pink);letter-spacing:.02em;}

  .title{text-align:center;margin:20px 0 12px}
  h1{font-size:clamp(22px,6.2vw,34px);line-height:1.25;margin:8px 0 12px}
  .lead{color:var(--muted);text-align:center;font-size:clamp(14px,2.3vw,17px);line-height:1.9;max-width:620px;margin:0 auto 12px;}

  /* carousel */
  .bleed{width:100vw;margin-left:50%;transform:translateX(-50%)}
  .carousel-wrap{margin-top:14px}
  .carousel{
    display:flex; gap:16px; overflow-x:auto;
    scroll-snap-type:x mandatory;
    padding:8px 0 22px; scrollbar-width:none;
  }
  .carousel::-webkit-scrollbar{display:none}
  .carousel::before,.carousel::after{content:"";flex:0 0 calc((100% - var(--card-w))/2)}

  .card{
    flex:0 0 var(--card-w); height:var(--card-h);
    background:var(--card-bg); border-radius:var(--radius);
    scroll-snap-align:center; overflow:hidden;
    display:flex; flex-direction:column; position:relative;
  }

  /* ▼ eギフト対象のカード（影なしで外枠だけ） */
  .card.egift{
    background:linear-gradient(135deg,#fff9fc,#fff);
    border:2px solid rgba(245,143,177,.35);
  }

  .egift-tag{
    position:absolute; top:10px; right:10px;
    background:#fbd7e5;
    color:#c14d7b;
    padding:4px 8px;
    border-radius:8px;
    font-size:11px;
    font-weight:700;
  }

  /* 写真アップロードエリア（正方形） */
  .ph{
    margin:12px 14px 6px;
  }
  .ph-inner{
    position:relative;
    display:block;
    width:100%;
    padding-top:100%;           /* 正方形を維持 */
    border-radius:18px;
    background:#fff;
    border:2px dashed rgba(245,143,177,.75);
    overflow:hidden;
    cursor:pointer;
  }
  .ph-input{
    display:none;
  }
  .ph-placeholder{
    position:absolute;
    inset:0;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    text-align:center;
    color:#333;
    font-size:13px;
  }
  .ph-icon{
    width:42px;
    height:42px;
    margin:0 auto 8px;
    border-radius:21px;
    background:rgba(250,153,125,0.08);
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .ph-icon svg{
    width:20px;
    height:20px;
    stroke:#f39a63;
  }

  .ph-img{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    display:none;
  }
  .ph.has-image .ph-inner{
    border-style:solid;
    border-color:rgba(0,0,0,0.06);
  }
  .ph.has-image .ph-placeholder{
    display:none;
  }
  .ph.has-image .ph-img{
    display:block;
  }

  .card-body{
    padding:4px 16px 16px;
    display:flex;
    flex-direction:column;
    gap:8px;
    height:100%;
  }

  .field{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .field + .field{
    margin-top:6px;
    padding-top:8px;
    border-top:1px solid rgba(240,141,176,.30); /* 薄いピンクの区切り線 */
  }

  .field-label{
    font-size:12px;
    color:var(--muted);
  }

  /* カード内テキスト：プレビュー専用（クリックでモーダル） */
  .field-value{
    margin:0;
    cursor:pointer;
    overflow:hidden;
    display:-webkit-box;
    -webkit-box-orient:vertical;
  }

  .field-value.title{
    font-size:14px;
    line-height:1.6;
    -webkit-line-clamp:1;  /* 1行で … */
    text-align:left;
  }

  .field-value.desc{
    font-size:14px;
    line-height:1.7;
    color:#555;
    -webkit-line-clamp:3;  /* 3行で … */
  }

  /* 「未入力」プレースホルダ */
  .field-value.is-empty{
    color:#c4c4c4;
  }

  /* pager dots */
  .pager{
    margin:4px 0 0;
    display:flex;
    justify-content:center;
    gap:8px;
  }
  .pager-dot{
    width:7px;
    height:7px;
    border-radius:50%;
    border:none;
    padding:0;
    background:rgba(255,255,255,0.7);
    box-shadow:0 0 0 1px rgba(0,0,0,0.06);
    cursor:pointer;
  }
  .pager-dot.is-active{
    background:#333;
  }

  /* footer */
  .footer{
    padding:12px 8px calc(36px + var(--safe-bottom));
    margin-top:18px;
  }
  .row{display:flex;gap:12px}
  .btn{
    flex:1;padding:16px 20px;border-radius:14px;border:1px solid #eee;
    background:#fff;color:#333;cursor:pointer;
  }
  .btn-prim{
    background:var(--grad);color:#fff;border:none;font-weight:800;
  }

  /* ===== モーダル ===== */
  body.is-modal-open{
    overflow:hidden;
  }
  .modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.22);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px 16px;
    opacity:0;
    pointer-events:none;
    transition:opacity .22s ease;
    z-index:40;
  }
  .modal-backdrop.is-open{
    opacity:1;
    pointer-events:auto;
  }
  .modal-dialog{
    max-width:420px;
    width:100%;
    background:#fff7f9;
    border-radius:18px;
    box-shadow:0 18px 40px rgba(0,0,0,.22);
    padding:18px 18px 20px;
    position:relative;
  }
  .modal-title{
    font-size:16px;
    font-weight:700;
    margin:0 0 6px;
  }
  .modal-hint{
    font-size:12px;
    color:var(--muted);
    margin:0 0 12px;
  }
  .modal-textarea{
    width:100%;
    min-height:170px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.12);
    padding:10px 12px;
    font-family:inherit;
    font-size:14px;
    line-height:1.7;
    resize:vertical;
    box-sizing:border-box;
  }
  .modal-footer{
    margin-top:14px;
    display:flex;
    gap:8px;
    justify-content:flex-end;
  }
  .modal-btn{
    flex:1;
    border-radius:999px;
    padding:11px;
    font-size:13px;
    letter-spacing:.08em;
    text-transform:uppercase;
    cursor:pointer;
  }
  .modal-btn.cancel{
    background:#fff7f9;
    border:1px solid rgba(0,0,0,.16);
    color:#2b2b2b;
  }
  .modal-btn.save{
    background:#000;
    border:none;
    color:#fff;
    font-weight:600;
    box-shadow:0 10px 22px rgba(0,0,0,.16);
  }
  .modal-btn.save:active,
  .modal-btn.cancel:active{
    transform:translateY(1px);
  }
</style>
</head>
<body>

<div class="wrap">
  <header class="header">
    <div class="logo">
      <svg viewBox="0 0 24 24" width="28" height="28" fill="none"
        stroke="var(--pink)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="8" width="18" height="12" rx="2"/>
        <path d="M12 8v12"/><path d="M3 12h18"/>
        <path d="M7.5 6a2.5 2.5 0 1 1 5 0v2h-5V6z"/>
        <path d="M11.5 6a2.5 2.5 0 1 1 5 0v2h-5V6z"/>
      </svg>
    </div>
    <div class="brand">えらべるギフト</div>
  </header>

  <main class="main">
    <section class="title">
      <h1>商品情報の確認</h1>
      <p class="lead">商品情報からカタログを作成しました<br>内容の確認＆修正をお願いします</p>
    </section>

    <section class="carousel-wrap bleed">
      <div class="carousel" id="carousel" aria-label="商品の確認スライダー">

        <!-- ▼ カード1 -->
        <article class="card" data-index="1">
          <div class="ph" data-photo-index="1">
            <label class="ph-inner" for="photo1">
              <input type="file" accept="image/*" id="photo1" class="ph-input">
              <img class="ph-img" alt="">
              <div class="ph-placeholder">
                <div class="ph-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 4v10"></path>
                    <path d="M8 8l4-4 4 4"></path>
                    <path d="M4 16v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2"></path>
                  </svg>
                </div>
                <div class="ph-placeholder-text">クリックして写真を選択</div>
              </div>
            </label>
          </div>
          <div class="card-body">
            <div class="field">
              <div class="field-label">商品名</div>
              <h3 class="field-value title" data-edit="title">商品名</h3>
            </div>
            <div class="field">
              <div class="field-label">商品説明</div>
              <p class="field-value desc" data-edit="desc">商品説明文</p>
            </div>
          </div>
        </article>

        <!-- ▼ カード2 -->
        <article class="card" data-index="2">
          <div class="ph" data-photo-index="2">
            <label class="ph-inner" for="photo2">
              <input type="file" accept="image/*" id="photo2" class="ph-input">
              <img class="ph-img" alt="">
              <div class="ph-placeholder">
                <div class="ph-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 4v10"></path>
                    <path d="M8 8l4-4 4 4"></path>
                    <path d="M4 16v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2"></path>
                  </svg>
                </div>
                <div class="ph-placeholder-text">クリックして写真を選択</div>
              </div>
            </label>
          </div>
          <div class="card-body">
            <div class="field">
              <div class="field-label">商品名</div>
              <h3 class="field-value title" data-edit="title">商品名</h3>
            </div>
            <div class="field">
              <div class="field-label">商品説明</div>
              <p class="field-value desc" data-edit="desc">商品説明文</p>
            </div>
          </div>
        </article>

        <!-- ▼ カード3 -->
        <article class="card" data-index="3">
          <div class="ph" data-photo-index="3">
            <label class="ph-inner" for="photo3">
              <input type="file" accept="image/*" id="photo3" class="ph-input">
              <img class="ph-img" alt="">
              <div class="ph-placeholder">
                <div class="ph-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 4v10"></path>
                    <path d="M8 8l4-4 4 4"></path>
                    <path d="M4 16v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2"></path>
                  </svg>
                </div>
                <div class="ph-placeholder-text">クリックして写真を選択</div>
              </div>
            </label>
          </div>
          <div class="card-body">
            <div class="field">
              <div class="field-label">商品名</div>
              <h3 class="field-value title" data-edit="title">商品名</h3>
            </div>
            <div class="field">
              <div class="field-label">商品説明</div>
              <p class="field-value desc" data-edit="desc">商品説明文</p>
            </div>
          </div>
        </article>

      </div>

      <!-- ▼ ページャードット ▼ -->
      <div class="pager" id="pager">
        <button class="pager-dot is-active" type="button" data-index="1"></button>
        <button class="pager-dot" type="button" data-index="2"></button>
        <button class="pager-dot" type="button" data-index="3"></button>
      </div>
      <!-- ▲ ページャードット ▲ -->

    </section>
  </main>

  <footer class="footer">
    <div class="row">
      <button class="btn" id="prevBtn" type="button">戻る</button>
      <button class="btn btn-prim" id="nextBtn" type="button">次へ</button>
    </div>
  </footer>
</div>

<!-- ▼ 編集モーダル ▼ -->
<div class="modal-backdrop" id="editModal">
  <div class="modal-dialog">
    <h2 class="modal-title" id="editModalTitle">テキストを編集</h2>
    <p class="modal-hint" id="editModalHint"></p>
    <textarea class="modal-textarea" id="editTextarea"></textarea>
    <div class="modal-footer">
      <button class="modal-btn cancel" type="button" id="editCancel">キャンセル</button>
      <button class="modal-btn save" type="button" id="editSave">保存する</button>
    </div>
  </div>
</div>
<!-- ▲ 編集モーダル ▲ -->

<script>
const FORM_KEY = "giftDraft_v1";
let draft = {};
try{
  const raw = localStorage.getItem(FORM_KEY);
  if(raw){
    draft = JSON.parse(raw) || {};
  }
}catch(e){
  draft = {};
}

// 元の URL のクエリ（id / preview / egift など）
const srcParams = new URLSearchParams(window.location.search);

// 次のページに引き継ぐパラメータ（必要に応じて追加してOK）
const KEEP_KEYS = ["id", "preview", "egift"];

function buildUrl(target){
  const base = new URLSearchParams();
  KEEP_KEYS.forEach(key=>{
    const v = srcParams.get(key);
    if(v !== null) base.set(key, v);
  });
  const qs = base.toString();
  return qs ? `${target}?${qs}` : target;
}

const urlParams = srcParams;

function getUrlForIndex(index){
  const candidates = ["url"+index,"link"+index,"productUrl"+index];
  for(const key of candidates){
    const v = draft[key];
    if(typeof v === "string" && v.trim()) return v.trim();
  }
  for(const key of candidates){
    const v = urlParams.get(key);
    if(v && v.trim()) return v.trim();
  }
  return "";
}

function ensurePerUrlEntry(index){
  if(!draft.perUrl || typeof draft.perUrl !== "object"){
    draft.perUrl = {};
  }
  const url = getUrlForIndex(index);
  const urlKey = url || ("slot"+index);
  if(!draft.perUrl[urlKey]){
    draft.perUrl[urlKey] = { url, title:"", desc:"", imgData:"" };
  }else{
    draft.perUrl[urlKey].url = url;
    if(typeof draft.perUrl[urlKey].imgData !== "string"){
      draft.perUrl[urlKey].imgData = "";
    }
  }
  return { url, urlKey, data: draft.perUrl[urlKey] };
}

function getTitleForIndex(index){
  const entry = ensurePerUrlEntry(index);
  const data  = entry.data;
  if(data.title && data.title.trim()) return data.title;
  const legacyKey = "title"+index;
  if(draft[legacyKey] && draft[legacyKey].trim()) return draft[legacyKey];
  return urlParams.get(legacyKey) || "";
}

function getDescForIndex(index){
  const entry = ensurePerUrlEntry(index);
  const data  = entry.data;
  if(data.desc && data.desc.trim()) return data.desc;
  const legacyKey = "desc"+index;
  if(draft[legacyKey] && draft[legacyKey].trim()) return draft[legacyKey];
  return urlParams.get(legacyKey) || "";
}

function getEgiftIndices(){
  let indices = [];
  if(Array.isArray(draft.egift)){
    indices = draft.egift.map(n=>parseInt(n,10)).filter(n=>!isNaN(n));
  }else if(typeof draft.egift === "string"){
    indices = draft.egift.split(",").map(n=>parseInt(n,10)).filter(n=>!isNaN(n));
  }
  if(!indices.length){
    const egiftRaw = urlParams.get("egift") || "";
    indices = egiftRaw.split(",").map(n=>parseInt(n,10)).filter(n=>!isNaN(n));
  }
  return indices;
}
const egiftList = getEgiftIndices();

function saveDraft(){
  try{
    localStorage.setItem(FORM_KEY, JSON.stringify(draft));
  }catch(e){
    console.error("localStorage save error", e);
  }
}

const cards    = Array.from(document.querySelectorAll(".card"));
const carousel = document.getElementById("carousel");
const dots     = Array.from(document.querySelectorAll(".pager-dot"));

/* カード初期反映 */
cards.forEach(card=>{
  const index   = parseInt(card.dataset.index,10);
  const titleEl = card.querySelector("[data-edit='title']");
  const descEl  = card.querySelector("[data-edit='desc']");

  ensurePerUrlEntry(index);

  const title = getTitleForIndex(index);
  const desc  = getDescForIndex(index);

  if(title){
    titleEl.textContent = title;
    titleEl.classList.remove("is-empty");
  }else{
    titleEl.textContent = "商品名を入力してください";
    titleEl.classList.add("is-empty");
  }

  if(desc){
    descEl.textContent = desc;
    descEl.classList.remove("is-empty");
  }else{
    descEl.textContent = "商品説明文を入力してください";
    descEl.classList.add("is-empty");
  }

  if(egiftList.includes(index)){
    card.classList.add("egift");
    const tag = document.createElement("div");
    tag.className = "egift-tag";
    tag.textContent = "eギフト対象";
    card.appendChild(tag);
  }
});

/* 写真アップロード（上書き可 & localStorage 永続化） */
document.querySelectorAll(".ph").forEach(ph=>{
  const imgEl       = ph.querySelector(".ph-img");
  const input       = ph.querySelector(".ph-input");
  const photoIndex  = parseInt(ph.dataset.photoIndex,10);

  // 既存の画像データがあれば復元
  const { urlKey } = ensurePerUrlEntry(photoIndex);
  const per = draft.perUrl[urlKey];
  if(per && per.imgData){
    imgEl.src = per.imgData;
    ph.classList.add("has-image");
  }

  input.addEventListener("change", ()=>{
    const file = input.files && input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e=>{
      const dataUrl = e.target.result;
      imgEl.src = dataUrl;
      ph.classList.add("has-image");

      const { urlKey } = ensurePerUrlEntry(photoIndex);
      if(!draft.perUrl[urlKey]){
        draft.perUrl[urlKey] = { url:getUrlForIndex(photoIndex), title:"", desc:"", imgData:"" };
      }
      draft.perUrl[urlKey].imgData = dataUrl;  // 上書き保存
      saveDraft();
    };
    reader.readAsDataURL(file);
  });
});

/* ページャードットとスクロール同期 */
let currentIndex = 1;

function setActiveIndex(idx, opts){
  currentIndex = idx;
  dots.forEach(dot=>{
    dot.classList.toggle("is-active", parseInt(dot.dataset.index,10) === idx);
  });
  if(opts && opts.scroll){
    const card = cards.find(c=>parseInt(c.dataset.index,10) === idx);
    if(card){
      card.scrollIntoView({behavior:opts.behavior || "smooth", inline:"center", block:"nearest"});
    }
  }
}

dots.forEach(dot=>{
  dot.addEventListener("click", ()=>{
    const idx = parseInt(dot.dataset.index,10);
    setActiveIndex(idx, {scroll:true, behavior:"smooth"});
  });
});

let scrollTimer;
carousel.addEventListener("scroll", ()=>{
  clearTimeout(scrollTimer);
  scrollTimer = setTimeout(()=>{
    const rect = carousel.getBoundingClientRect();
    const centerX = rect.left + rect.width/2;
    let bestIdx = currentIndex;
    let bestDist = Infinity;
    cards.forEach(card=>{
      const r = card.getBoundingClientRect();
      const mid = r.left + r.width/2;
      const d   = Math.abs(mid - centerX);
      if(d < bestDist){
        bestDist = d;
        bestIdx = parseInt(card.dataset.index,10);
      }
    });
    if(bestIdx !== currentIndex){
      setActiveIndex(bestIdx);
    }
  },80);
});

setActiveIndex(1);

/* ===== モーダルで全文編集 ===== */
const editModal    = document.getElementById("editModal");
const editTextarea = document.getElementById("editTextarea");
const editTitleEl  = document.getElementById("editModalTitle");
const editHintEl   = document.getElementById("editModalHint");
const editCancel   = document.getElementById("editCancel");
const editSave     = document.getElementById("editSave");

let editingIndex = null;
let editingField = null; // "title" or "desc"

function openEditModal(index, field){
  editingIndex = index;
  editingField = field;

  const isTitle   = (field === "title");
  const fullTitle = getTitleForIndex(index);
  const fullDesc  = getDescForIndex(index);

  if(isTitle){
    editTitleEl.textContent = "商品名を編集";
    editHintEl.textContent  = "カタログに表示される商品名を編集できます。";
    editTextarea.value      = fullTitle || "";
  }else{
    editTitleEl.textContent = "商品説明を編集";
    editHintEl.textContent  = "カタログに表示される商品説明文を編集できます。";
    editTextarea.value      = fullDesc || "";
  }

  editModal.classList.add("is-open");
  document.body.classList.add("is-modal-open");
  editTextarea.focus();
}

function closeEditModal(){
  editModal.classList.remove("is-open");
  document.body.classList.remove("is-modal-open");
  editingIndex = null;
  editingField = null;
}

/* カードのクリックでモーダルを開く */
cards.forEach(card=>{
  const index   = parseInt(card.dataset.index,10);
  const titleEl = card.querySelector("[data-edit='title']");
  const descEl  = card.querySelector("[data-edit='desc']");

  titleEl.addEventListener("click", ()=>{
    openEditModal(index,"title");
  });
  descEl.addEventListener("click", ()=>{
    openEditModal(index,"desc");
  });
});

/* モーダルのキャンセル・保存 */
editCancel.addEventListener("click", closeEditModal);
editModal.addEventListener("click", (e)=>{
  if(e.target === editModal){
    closeEditModal();
  }
});

editSave.addEventListener("click", ()=>{
  if(editingIndex == null || !editingField) return;

  const text = editTextarea.value || "";
  const { urlKey } = ensurePerUrlEntry(editingIndex);

  if(!draft.perUrl[urlKey]){
    draft.perUrl[urlKey] = { url:getUrlForIndex(editingIndex), title:"", desc:"", imgData:"" };
  }

  if(editingField === "title"){
    draft.perUrl[urlKey].title = text;
    draft["title"+editingIndex] = text; // 旧仕様互換
  }else{
    draft.perUrl[urlKey].desc = text;
    draft["desc"+editingIndex] = text;
  }
  saveDraft();

  // カード側プレビューを更新
  const card = cards.find(c=>parseInt(c.dataset.index,10) === editingIndex);
  if(card){
    const el = card.querySelector(editingField === "title" ? "[data-edit='title']" : "[data-edit='desc']");
    if(el){
      if(text.trim()){
        el.textContent = text;
        el.classList.remove("is-empty");
      }else{
        el.textContent = editingField === "title"
          ? "商品名を入力してください"
          : "商品説明文を入力してください";
        el.classList.add("is-empty");
      }
    }
  }

  closeEditModal();
});

/* 戻る・次へ（id / preview / egift を引き継ぐ） */
document.getElementById("prevBtn").onclick = () => {
  window.location.href = buildUrl("giveselect.html");
};
document.getElementById("nextBtn").onclick = () => {
  window.location.href = buildUrl("message.html");
};
</script>

</body>
</html>
