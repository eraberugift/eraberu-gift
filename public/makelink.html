<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ギフトURLを共有 | えらべるギフト</title>
<link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">

<style>
  :root{
    --pink:#f58fb1;
    --ink:#2a2a2a;
    --muted:#6b7280;
    --bg-top:#fff1f6;
    --bg-bottom:#fde9d3;
    --grad-main:linear-gradient(90deg,#f08db0 0%,#f2b35e 100%);
    --vh:1svh;
    --screenH:calc(var(--vh) * 100);
  }

  *{ box-sizing:border-box; }
  html,body{ min-height:100vh;height:auto; }

  body{
    margin:0;
    font-family:"Kosugi Maru","Hiragino Maru Gothic ProN","Hiragino Sans","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    color:var(--ink);
    background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom)) fixed;
    background-size:100% 100%;
  }

  .wrap{
    max-width:960px;
    margin:0 auto;
    padding:16px 16px 40px;
    min-height:var(--screenH);
    display:flex;
    flex-direction:column;
  }

  .main{
    flex:1;
    display:flex;
    flex-direction:column;
  }

  /* header（送るデザイン画面と揃える） */
  .header{
    display:flex;
    align-items:center;
    gap:12px;
    padding-top:4px;
  }
  .brand{
    font-weight:800;
    font-size:22px;
    color:var(--pink);
    letter-spacing:.02em;
  }

  /* タイトルまわり（送るデザイン画面と同じレイアウト） */
  .title{
    text-align:center;
    margin:26px 0 18px;
  }
  h1{
    font-size:clamp(22px,6.2vw,32px);
    line-height:1.25;
    margin:8px 0 12px;
  }
  .lead{
    color:var(--muted);
    text-align:center;
    font-size:clamp(14px,2.3vw,16px);
    line-height:1.9;
    max-width:620px;
    margin:0 auto 12px;
    letter-spacing:.2px;
  }

  @media (max-width:600px){
    .title{margin:40px 0 18px}
    h1{margin:10px 0 16px}
    .lead{margin-bottom:18px}
  }

  /* 中央のコンテンツ幅を少し絞る */
  .content{
    max-width:460px;
    margin:0 auto;
    text-align:center;
  }

  /* プレゼント画像（枠なし・比率そのまま） */
  .present-illust{
    margin:10px 0 22px;
  }
  .present-illust img{
    width:min(220px, 60vw);
    height:auto;
    display:block;
    margin:0 auto;
  }

  .subcopy{
    margin:0 auto 26px;
    font-size:14px;
    max-width:360px;
    line-height:1.9;
  }
  .subcopy strong{ font-weight:700; }

  /* ボタン */
  .btn-area{
    display:flex;
    flex-direction:column;
    gap:14px;
    margin-top:10px;
  }

  .btn{
    width:100%;
    padding:14px;
    border-radius:999px;
    border:none;
    cursor:pointer;
    font-size:15px;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:opacity .12s, transform .12s;
  }
  .btn:active{
    transform:translateY(1px);
    opacity:.9;
  }

  .btn-primary{
    background:var(--grad-main);
    color:#fff;
    font-weight:800;
    box-shadow:0 12px 24px rgba(240,141,176,.32);
  }

  .btn-secondary{
    background:#fff;
    border:1px solid #ffd7e4;
    color:var(--pink);
    box-shadow:0 8px 18px rgba(0,0,0,.06);
  }

  .copy-msg{
    margin-top:10px;
    text-align:center;
    font-size:13px;
    color:#059669;
    min-height:1.2em;
  }

  .note{
    margin-top:10px;
    text-align:center;
    font-size:12px;
    color:var(--muted);
  }
</style>
</head>
<body>

<div class="wrap">
  <header class="header">
    <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="#f58fb1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="3" y="8" width="18" height="12" rx="2"/>
      <path d="M12 8v12"/><path d="M3 12h18"/>
      <path d="M7.5 6a2.5 2.5 0 1 1 5 0v2h-5V6z"/>
      <path d="M11.5 6a2.5 2.5 0 1 1 5 0v2h-5V6z"/>
    </svg>
    <div class="brand">えらべるギフト</div>
  </header>

  <main class="main">
    <section class="title">
      <h1>作成おつかれさまでした</h1>
      <p class="lead">
        きっと大切な人も喜んでくれるはずです。<br>
        ギフトURLをコピーして、LINEやSNSで送りましょう。
      </p>
    </section>

    <section class="content">
      <div class="present-illust">
        <img src="/assets/present_illust2.png" alt="プレゼントのイラスト">
      </div>

      <p class="subcopy">
        <strong>大切な人が心を込めて作ってくれました。<br>
        ぴったりの1つを選んでくださいね。</strong><br>
        というメッセージと一緒にカタログが表示されます。
      </p>

      <div class="btn-area">
        <button class="btn btn-primary" id="copyBtn">
          ギフトURLをコピーして送信する
        </button>
        <button class="btn btn-secondary" id="previewBtn">
          受け取りページをプレビューで確認する
        </button>
      </div>

      <p class="copy-msg" id="copyMsg"></p>
      <p class="note">※ プレビューは別タブで開きます</p>
    </section>
  </main>
</div>

<script>
  // 画面高さ補正（他ページと揃える）
  function setVH() {
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', vh + 'px');
  }
  setVH();
  window.addEventListener('resize', setVH, { passive:true });
  window.addEventListener('orientationchange', setVH);

  // ===== localStorage 共通処理 =====
  const MASTER_KEY = 'eraberuGift';

  function loadMaster(){
    try{
      return JSON.parse(localStorage.getItem(MASTER_KEY) || '{}');
    }catch(e){
      return {};
    }
  }

  // ▼ 修正：draft ではなく master を読み込む
  const state = loadMaster();

  // ▼ 修正：design ページで確定した ID を使う（生成しない）
  const giftId = state.catalogId;
  if (!giftId) {
    console.warn("⚠ catalogId が存在しません。フローの整合性を確認してください。");
  }

  // ▼ ベースURL（http://localhost:3000/〜 を含める）
  const origin  = window.location.origin || '';
  const baseDir = window.location.pathname.replace(/[^\/]*$/, '');
  const baseUrl = origin + baseDir;

  // ★ 送信用URL（preview なし）
  const realGiftUrl = `${baseUrl}giftopen.html?id=${encodeURIComponent(giftId)}`;

  const copyBtn    = document.getElementById("copyBtn");
  const previewBtn = document.getElementById("previewBtn");
  const copyMsg    = document.getElementById("copyMsg");

  // ▼ 修正：URLは master を元に、コピー時に saveState しない
  copyBtn.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(realGiftUrl);
      copyMsg.textContent = "ギフトURLをコピーしました！";

      const before = copyBtn.textContent;
      copyBtn.textContent = "コピーしました！";
      copyBtn.style.opacity = "0.9";

      setTimeout(()=>{
        copyBtn.textContent = before;
        copyBtn.style.opacity = "1";
      },1500);

    }catch(e){
      copyMsg.textContent = "コピーに失敗しました。長押しでコピーしてください。";
    }
  });

  // ▼ プレビュー（id + preview=1 を付けて別タブで開く）
  previewBtn.addEventListener("click", () => {
    const previewUrl = `${baseUrl}giftopen.html?id=${encodeURIComponent(giftId)}&preview=1`;
    window.open(previewUrl, "_blank");
  });
</script>


</body>
</html>
