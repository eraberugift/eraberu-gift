<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>商品情報の確認 | えらべるギフト</title>
<link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">

<style>
  :root{
    --pink:#f58fb1; --ink:#2a2a2a; --muted:#6b7280;
    --bg-top:#fff1f6; --bg-bottom:#fde9d3;
    --grad:linear-gradient(90deg,#f08db0 0%,#f2b35e 100%);
    --card-bg:#fff; --shadow:0 14px 30px rgba(0,0,0,.08); --radius:18px;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --vh: 1svh;
    --screenH: calc(var(--vh) * 100);
    --card-h: clamp(300px, calc(var(--screenH) * 0.52), 480px);
    --card-w: clamp(220px, calc(var(--card-h) * 0.68), 340px);
  }

  *{box-sizing:border-box}
  html,body{min-height:100vh;height:auto}
  body{
    margin:0;
    font-family:"Kosugi Maru","Hiragino Maru Gothic ProN","Hiragino Sans","Noto Sans JP",system-ui,-apple-system,sans-serif;
    color:var(--ink);
    background: linear-gradient(180deg,var(--bg-top),var(--bg-bottom)) fixed;
    background-size: 100% 100%;
  }
  a{color:inherit;text-decoration:none}

  .wrap{
    max-width:960px; margin:0 auto; padding:16px 16px 0;
    min-height:var(--screenH);
    display:flex; flex-direction:column;
  }
  .main{flex:1; display:flex; flex-direction:column;}

  .header{display:flex;align-items:center;gap:12px;padding-top:4px;}
  .logo{width:32px;height:32px;display:flex;align-items:center;justify-content:center}
  .brand{font-weight:800;font-size:22px;color:var(--pink);letter-spacing:.02em;}

  .title{text-align:center;margin:20px 0 8px}
  h1{font-size:clamp(22px,6.2vw,34px);line-height:1.25;margin:8px 0 8px}
  .lead{color:var(--muted);text-align:center;font-size:clamp(14px,2.3vw,17px);line-height:1.9;max-width:620px;margin:0 auto 4px;}

  .sub-hint{
    text-align:center;
    font-size:12px;
    color:var(--muted);
    margin:0 auto 10px;
    line-height:1.7;
  }

  /* carousel */
  .bleed{width:100vw;margin-left:50%;transform:translateX(-50%)}
  .carousel-wrap{margin-top:8px}
  .carousel{
    display:flex; gap:16px; overflow-x:auto;
    scroll-snap-type:x mandatory;
    padding:8px 0 22px; scrollbar-width:none;
  }
  .carousel::-webkit-scrollbar{display:none}
  .carousel::before,.carousel::after{content:"";flex:0 0 calc((100% - var(--card-w))/2)}

  .card{
    flex:0 0 var(--card-w); height:var(--card-h);
    background:var(--card-bg); border-radius:var(--radius);
    scroll-snap-align:center; overflow:hidden;
    display:flex; flex-direction:column; position:relative;
    border:1px solid rgba(0,0,0,.04);
    box-shadow:var(--shadow);
    transition:
      background .3s,
      box-shadow .18s ease,
      border-color .18s ease,
      transform .18s ease;
  }

  /* 編集中カードの強調 */
  .card:focus-within{
    border-color:rgba(245,143,177,.8);
    box-shadow:0 18px 36px rgba(245,143,177,.35);
    transform:translateY(-4px);
  }

  /* ▼ eギフト対象のカードの軽いハイライト */
  .card.egift{
    background:linear-gradient(135deg,#fff9fc,#fff);
    box-shadow:0 0 0 2px rgba(245,143,177,.28), var(--shadow);
  }

  .egift-tag{
    position:absolute; top:10px; right:10px;
    background:#fbd7e5;
    color:#c14d7b;
    padding:4px 8px;
    border-radius:999px;
    font-size:11px;
    font-weight:700;
  }

  /* A/B/C ラベル */
  .slot-pill{
    position:absolute;
    top:10px;
    left:10px;
    padding:3px 10px;
    border-radius:999px;
    background:rgba(255,255,255,.92);
    font-size:11px;
    color:var(--muted);
    box-shadow:0 6px 12px rgba(0,0,0,.06);
  }
  .slot-pill span{
    font-weight:700;
    color:var(--pink);
    margin-right:4px;
  }

  .ph{
    height:46%; margin:14px; border-radius:14px; background:#eee;
    display:grid; place-items:center; color:#bbb
  }
  .ph svg{opacity:.7}

  .card-body{
    padding:4px 14px 16px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .field{
    display:flex;
    flex-direction:column;
    gap:4px;
  }

  .field-label{
    font-size:11px;
    color:var(--muted);
    letter-spacing:.08em;
  }

  .card h3{
    margin:0;
    font-size:16px;
    line-height:1.5;
    min-height:1.5em;
  }

  .card p{
    margin:0;
    color:#555;
    line-height:1.7;
    font-size:14px;
    min-height:4.2em; /* 2〜3行分の高さを確保して揺れを防ぐ */
  }

  .editable{
    outline:none;
  }

  .editable:focus{
    background-color:rgba(255,255,255,.8);
    box-shadow:0 0 0 1px rgba(245,143,177,.45) inset;
    border-radius:10px;
  }

  .detail-link{
    display:inline-flex;
    align-items:center;
    gap:4px;
    margin-top:auto;
    padding-top:10px;
    font-size:13px;
    color:#ef77a6;
    cursor:pointer;
  }
  .detail-link::before{
    content:"";
    display:block;
    flex:1;
    height:1px;
    background:rgba(240,141,176,.35);
    margin-right:4px;
  }
  .detail-link::after{
    content:"↗";
    font-size:11px;
  }

  /* footer */
  .footer{
    padding:12px 8px calc(36px + var(--safe-bottom));
    margin-top:4px;
  }
  .row{display:flex;gap:12px}
  .btn{
    flex:1;padding:16px 20px;border-radius:14px;border:1px solid #eee;
    background:#fff;color:#333;cursor:pointer;
  }
  .btn-prim{
    background:var(--grad);color:#fff;border:none;font-weight:800;
  }
</style>
</head>
<body>

<div class="wrap">
  <header class="header">
    <div class="logo">
      <svg viewBox="0 0 24 24" width="28" height="28" fill="none"
        stroke="var(--pink)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="8" width="18" height="12" rx="2"/>
        <path d="M12 8v12"/><path d="M3 12h18"/>
        <path d="M7.5 6a2.5 2.5 0 1 1 5 0v2h-5V6z"/>
        <path d="M11.5 6a2.5 2.5 0 1 1 5 0v2h-5V6z"/>
      </svg>
    </div>
    <div class="brand">えらべるギフト</div>
  </header>

  <main class="main">
    <section class="title">
      <h1>商品情報の確認</h1>
      <p class="lead">商品情報からカタログを作成しました</p>
      <p class="sub-hint">各カードの「商品名」と「商品説明」はタップして編集できます。<br>入力した内容は自動で保存されます。</p>
    </section>

    <section class="carousel-wrap bleed">
      <div class="carousel" id="carousel" aria-label="商品の確認スライダー">

        <!-- ▼ カードは JS で上書きするので初期値はこのままでOK -->
        <article class="card" data-index="1">
          <div class="slot-pill"><span>A</span>1つ目の商品</div>
          <div class="ph"></div>
          <div class="card-body">
            <div class="field">
              <div class="field-label">商品名</div>
              <h3 class="editable" contenteditable="true">商品名</h3>
            </div>
            <div class="field">
              <div class="field-label">商品説明</div>
              <p class="editable" contenteditable="true">商品説明文</p>
            </div>
            <a href="#" class="detail-link" data-open>商品の詳細を確認する</a>
          </div>
        </article>

        <article class="card" data-index="2">
          <div class="slot-pill"><span>B</span>2つ目の商品</div>
          <div class="ph"></div>
          <div class="card-body">
            <div class="field">
              <div class="field-label">商品名</div>
              <h3 class="editable" contenteditable="true">商品名</h3>
            </div>
            <div class="field">
              <div class="field-label">商品説明</div>
              <p class="editable" contenteditable="true">商品説明文</p>
            </div>
            <a href="#" class="detail-link" data-open>商品の詳細を確認する</a>
          </div>
        </article>

        <article class="card" data-index="3">
          <div class="slot-pill"><span>C</span>3つ目の商品</div>
          <div class="ph"></div>
          <div class="card-body">
            <div class="field">
              <div class="field-label">商品名</div>
              <h3 class="editable" contenteditable="true">商品名</h3>
            </div>
            <div class="field">
              <div class="field-label">商品説明</div>
              <p class="editable" contenteditable="true">商品説明文</p>
            </div>
            <a href="#" class="detail-link" data-open>商品の詳細を確認する</a>
          </div>
        </article>

      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="row">
      <button class="btn" id="prevBtn" type="button">戻る</button>
      <button class="btn btn-prim" id="nextBtn" type="button">次へ</button>
    </div>
  </footer>
</div>

<script>
/* ===== localStorage からデータ取得 ===== */
const FORM_KEY = "giftDraft_v1";
let draft = {};
try{
  const raw = localStorage.getItem(FORM_KEY);
  if(raw){
    draft = JSON.parse(raw) || {};
  }
}catch(e){
  draft = {};
}

/* ===== URL パラメータ（バックアップ用フォールバック） ===== */
const urlParams = new URLSearchParams(window.location.search);

/**
 * 現在のカタログで「index番目の商品URL」を取得
 * - 優先: localStorage (url1 / link1 / productUrl1 などを想定)
 * - 次に: クエリパラメータ
 */
function getUrlForIndex(index){
  const candidates = [
    "url" + index,
    "link" + index,
    "productUrl" + index
  ];

  for(const key of candidates){
    const v = draft[key];
    if(typeof v === "string" && v.trim()){
      return v.trim();
    }
  }

  for(const key of candidates){
    const v = urlParams.get(key);
    if(v && v.trim()){
      return v.trim();
    }
  }

  return "";
}

/**
 * URLごとの保存領域を初期化・取得
 * - draft.perUrl = { [urlKey]: { url, title, desc } }
 * - urlKey は「URL文字列」 or 「slotN」（URL不明の場合）
 */
function ensurePerUrlEntry(index){
  if(!draft.perUrl || typeof draft.perUrl !== "object"){
    draft.perUrl = {};
  }

  const url = getUrlForIndex(index);
  const urlKey = url || ("slot" + index); // URLが取れない場合も一応キーを持たせる

  if(!draft.perUrl[urlKey]){
    draft.perUrl[urlKey] = {
      url: url,
      title: "",
      desc: ""
    };
  }else{
    // URL情報だけは最新で持っておく
    draft.perUrl[urlKey].url = url;
  }

  return { url, urlKey, data: draft.perUrl[urlKey] };
}

/**
 * タイトルを URL 単位で取得
 * - 1) URL単位の保存データ
 * - 2) 旧仕様: title1 / ?title1 の値（後方互換）
 */
function getTitleForIndex(index){
  const entry = ensurePerUrlEntry(index);
  const data = entry.data;

  if(data.title && data.title.trim()){
    return data.title;
  }

  const legacyKey = "title" + index;
  if(draft[legacyKey] && draft[legacyKey].trim()){
    return draft[legacyKey];
  }

  const fromQuery = urlParams.get(legacyKey);
  return fromQuery || "";
}

/**
 * 説明文を URL 単位で取得
 * - 1) URL単位の保存データ
 * - 2) 旧仕様: desc1 / ?desc1 の値（後方互換）
 */
function getDescForIndex(index){
  const entry = ensurePerUrlEntry(index);
  const data = entry.data;

  if(data.desc && data.desc.trim()){
    return data.desc;
  }

  const legacyKey = "desc" + index;
  if(draft[legacyKey] && draft[legacyKey].trim()){
    return draft[legacyKey];
  }

  const fromQuery = urlParams.get(legacyKey);
  return fromQuery || "";
}

/* ===== egift のインデックス配列を取得（1,2,3...） ===== */
function getEgiftIndices(){
  let indices = [];

  // 1) localStorage 優先
  if(Array.isArray(draft.egift)){
    indices = draft.egift.map(n => parseInt(n,10)).filter(n => !isNaN(n));
  }else if(typeof draft.egift === "string"){
    indices = draft.egift.split(",").map(n => parseInt(n,10)).filter(n => !isNaN(n));
  }

  // 2) 何もなければ URL パラメータから（後方互換）
  if(!indices.length){
    const egiftRaw = urlParams.get("egift") || "";
    indices = egiftRaw.split(",").map(n => parseInt(n,10)).filter(n => !isNaN(n));
  }

  return indices;
}

const egiftList = getEgiftIndices();

/* ===== 共通: draft を保存 ===== */
function saveDraft(){
  try{
    localStorage.setItem(FORM_KEY, JSON.stringify(draft));
  }catch(e){
    console.error("localStorage save error", e);
  }
}

/* 中央に寄せるヘルパー */
function centerCard(card){
  card.scrollIntoView({
    behavior:"smooth",
    inline:"center",
    block:"nearest"
  });
}

/* ===== カードへ反映 ＋ 編集内容を URL 単位で保存 ===== */
const cards = document.querySelectorAll(".card");

cards.forEach(card => {
  const index = parseInt(card.dataset.index, 10);
  const titleEl = card.querySelector("h3");
  const descEl  = card.querySelector("p");

  // URL単位のエントリを確保
  const entry = ensurePerUrlEntry(index);

  // 商品名反映
  const title = getTitleForIndex(index);
  if(title){
    titleEl.textContent = title;
  }

  // 説明文反映
  const desc = getDescForIndex(index);
  if(desc){
    descEl.textContent = desc;
  }

  // eギフト対象ならタグ追加＋見た目変更
  if(egiftList.includes(index)){
    card.classList.add("egift");
    const tag = document.createElement("div");
    tag.className = "egift-tag";
    tag.textContent = "eギフト対象";
    card.appendChild(tag);
  }

  // フォーカス時にカードを中央へ
  titleEl.addEventListener("focus", () => centerCard(card));
  descEl.addEventListener("focus", () => centerCard(card));

  // ===== 編集イベントで URL 単位に保存 =====
  titleEl.addEventListener("input", () => {
    const { urlKey } = ensurePerUrlEntry(index);
    if(!draft.perUrl[urlKey]){
      draft.perUrl[urlKey] = {
        url: getUrlForIndex(index),
        title: "",
        desc: ""
      };
    }
    draft.perUrl[urlKey].title = titleEl.textContent.trim();
    saveDraft();
  });

  descEl.addEventListener("input", () => {
    const { urlKey } = ensurePerUrlEntry(index);
    if(!draft.perUrl[urlKey]){
      draft.perUrl[urlKey] = {
        url: getUrlForIndex(index),
        title: "",
        desc: ""
      };
    }
    draft.perUrl[urlKey].desc = descEl.textContent.trim();
    saveDraft();
  });
});

/* ===== 戻る・次へ ===== */
// 戻る：お届け方法の選択（ファイル名は運用に合わせて）
document.getElementById("prevBtn").onclick = () => {
  // 状態は localStorage に残るのでクエリ不要
  window.location.href = "giveselect.html";
};

// 次へ：理由入力画面へ
document.getElementById("nextBtn").onclick = () => {
  // input イベントで随時保存しているので、ここではそのまま遷移
  window.location.href = "reason.html";
};
</script>

</body>
</html>
