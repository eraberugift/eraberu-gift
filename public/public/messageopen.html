<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>メッセージがとどきました | えらべるギフト</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #f1ece8;
      --ink: #2b2b2b;
      --muted: #7a7268;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --card-w: min(340px, 82vw);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      background:var(--bg);
      font-family:"Noto Sans JP","Hiragino Sans","-apple-system",system-ui,sans-serif;
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      opacity:0;
      transition: opacity .9s ease;
    }
    body.is-visible{
      opacity:1;
    }

    .app{
      max-width:480px;
      margin:0 auto;
      padding:24px 16px calc(24px + var(--safe-bottom));
    }

    .header{
      text-align:center;
      margin-bottom:28px;
    }

    .title{
      font-size:26px;
      letter-spacing:.16em;
      text-transform:uppercase;
      font-weight:700;
    }

    .caption{
      margin-top:6px;
      font-size:11px;
      letter-spacing:.1em;
      text-transform:uppercase;
      color:var(--muted);
    }

    main{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:18px;
    }

    .message-area{
      width:100%;
      max-width:var(--card-w);
    }

    .photo-wrap{
      display:flex;
      justify-content:center;
      margin-bottom:16px;
    }

    .photo-frame{
      width:100%;
      max-width:260px;
      aspect-ratio:1 / 1;
      display:flex;
      align-items:center;
      justify-content:center;
      background:transparent;
      border:none;
      overflow:visible;
      position:relative;
    }

    .photo-frame img{
      width:86%;
      height:86%;
      object-fit:cover;
      background:#fff;
      border:1px solid #111;
      box-sizing:border-box;
      display:block;
      filter:
        saturate(0.8)
        contrast(0.75);
    }

    .photo-frame::after{
      content:"";
      position:absolute;
      inset:7%;
      pointer-events:none;
      mix-blend-mode:soft-light;
      opacity:.7;
      background-image:
        radial-gradient(circle at 0 0, rgba(0,0,0,.18) 0, transparent 55%),
        radial-gradient(circle at 100% 0, rgba(0,0,0,.12) 0, transparent 55%),
        radial-gradient(circle at 0 100%, rgba(0,0,0,.14) 0, transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(0,0,0,.16) 0, transparent 55%);
      background-size:18px 18px;
    }

    .message-meta{
      font-size:11px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
      margin-bottom:6px;
    }

    .message-to{
      font-size:13px;
      margin-bottom:6px;
    }

    .message-body{
      font-size:13px;
      line-height:1.8;
      white-space:pre-wrap;
      margin:0 0 10px;
    }

    .message-from{
      font-size:12px;
      text-align:right;
      margin-top:8px;
    }

    .hint{
      max-width:var(--card-w);
      font-size:11px;
      color:var(--muted);
      line-height:1.6;
      text-align:left;
      margin-top:4px;
    }

    .footer{
      margin-top:24px;
    }

    .btn-primary{
      width:100%;
      background:#000;
      color:#fff;
      border:none;
      border-radius:999px;
      padding:15px;
      font-size:14px;
      font-weight:600;
      letter-spacing:.14em;
      text-transform:uppercase;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(0,0,0,.16);
    }
  </style>
</head>
<body>

  <div class="app">
    <header class="header">
      <div class="title">A GIFT LETTER</div>
      <div class="caption">FROM YOUR FRIEND</div>
    </header>

    <main>
      <section class="message-area">
        <div class="photo-wrap">
          <div class="photo-frame">
            <!-- 初期サンプル（JSで差し替え） -->
            <img
              id="messagePhoto"
              src="https://i.pinimg.com/736x/71/eb/f3/71ebf3b18655ec2c3d05b9119e951f89.jpg"
              alt="gift memory">
          </div>
        </div>

        <div class="message-block">
          <div class="message-meta">message</div>

          <p class="message-to" id="messageTo">○○さんへ</p>

          <p class="message-body" id="messageBody">
いつもありがとう！
今回は「えらべるギフト」で
○○さんにぴったりなものを
選んでもらえたらうれしいです。
          </p>

          <p class="message-from" id="messageFrom">△△より</p>
        </div>
      </section>

      <p class="hint">
        下のボタンから、プレゼントしてもらったギフトをえらぶことができます。
      </p>
    </main>

    <footer class="footer">
      <button class="btn-primary" id="toGift">
        ギフトをえらびにいく
      </button>
    </footer>

  </div>

  <script>
    // master（eraberuGift）のみ扱う
    function loadState(){
      try{
        return JSON.parse(localStorage.getItem("eraberuGift") || "{}");
      }catch(e){
        return {};
      }
    }
    function saveState(patch){
      const current = loadState();
      const next = Object.assign({}, current, patch || {});
      try{
        localStorage.setItem("eraberuGift", JSON.stringify(next));
      }catch(e){}
    }

    function initMessagePage(){
      const params = new URLSearchParams(location.search);

      // === ★ preview フラグ（このページのURLだけを見て判定） ===
      const previewParam = params.get("preview");
      const isPreview =
        previewParam === "1" || previewParam === "true";

      // このページがプレビューならフラグを立てる / そうでなければ消す
      if (isPreview){
        sessionStorage.setItem("eraberuGift_preview", "1");
      } else {
        sessionStorage.removeItem("eraberuGift_preview");
      }

      window.__ERABERU_PREVIEW__ = isPreview;
      // === ★ ここまで修正ポイント ===

      const urlId = params.get("id");

      // master 読み込み
      let state = loadState();

      // id を優先して catalogId を決定
      let catalogId = urlId || state.catalogId || state.giftId || null;

      // URL の id があれば master 側にも反映（他フィールドは維持）
      if (urlId && urlId !== state.catalogId){
        saveState({ catalogId: urlId });
        state = loadState();
      }

      const photoEl = document.getElementById("messagePhoto");
      const toEl    = document.getElementById("messageTo");
      const bodyEl  = document.getElementById("messageBody");
      const fromEl  = document.getElementById("messageFrom");

      // 写真URL（DataURL含む） master から取得
      const photoUrl =
        state.messagePhotoUrl ||   // giftcard_design で確定した URL / DataURL
        state.messagePhotoData ||  // 過去互換（万が一 master にそのまま入っていた場合）
        state.photoUrl ||
        state.memoryPhotoUrl ||
        "";

      if (photoUrl){
        photoEl.src = photoUrl;
      }

      // 宛名・本文・送り主（masterのみ）
      const toName   = state.messageTo   || state.toName;
      const fromName = state.messageFrom || state.fromName;
      const bodyText = state.messageBody || state.messageText;

      if (toName){
        // 末尾に「へ」が無ければ付ける（スペース除外）
        const clean = toName.trim();
        toEl.textContent = clean.endsWith("へ") ? clean : (clean + " へ");
        }

      if (bodyText){
        bodyEl.innerText = bodyText || "";
      }
      if (fromName){
        fromEl.textContent =
          fromName.endsWith(" より") ? fromName : (fromName + " より");
      }

      // 次ページ（ギフト選択）へ遷移
      const btn = document.getElementById("toGift");
      if (btn){
        btn.addEventListener("click", function(){
            const base = location.pathname.replace(/[^\/]*$/, "");
            let url = base + "giftcatalogopen.html";

          const query = [];

          if (catalogId){
            query.push("id=" + encodeURIComponent(catalogId));
          }
          if (isPreview){
            query.push("preview=1");
          }

          if (query.length){
            url += "?" + query.join("&");
          }

          window.location.href = url;
        });
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      requestAnimationFrame(() => {
        document.body.classList.add("is-visible");
      });
      initMessagePage();
    });
  </script>

</body>
</html>
