<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>送るデザインをえらぶ | えらべるギフト</title>
<link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">

<style>
  :root{
    --pink:#f58fb1; --ink:#2a2a2a; --muted:#6b7280;
    --bg-top:#fff1f6; --bg-bottom:#fde9d3;
    --grad:linear-gradient(90deg,#f08db0 0%,#f2b35e 100%);
    --card-bg:#fff; --shadow:0 14px 30px rgba(0,0,0,.08); --radius:22px;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --vh:1svh;
    --screenH:calc(var(--vh) * 100);
  }

  *{box-sizing:border-box}
  html,body{min-height:100vh;height:auto}
  body{
    margin:0;
    font-family:"Kosugi Maru","Hiragino Maru Gothic ProN","Hiragino Sans","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    color:var(--ink);
    background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom)) fixed;
    background-size:100% 100%;
  }
  a{color:inherit;text-decoration:none}

  .wrap{
    max-width:960px;
    margin:0 auto;
    padding:16px 16px 0;
    min-height:var(--screenH);
    display:flex;
    flex-direction:column;
  }
  .main{flex:1;display:flex;flex-direction:column;}

  /* header */
  .header{display:flex;align-items:center;gap:12px;padding-top:4px;}
  .logo{width:32px;height:32px;display:flex;align-items:center;justify-content:center;}
  .brand{font-weight:800;font-size:22px;color:var(--pink);letter-spacing:.02em;}

  /* title */
  .title{text-align:center;margin:26px 0 14px}
  h1{
    font-size:clamp(22px,6.2vw,32px);
    line-height:1.25;
    margin:8px 0 12px;
  }
  .lead{
    color:var(--muted);
    text-align:center;
    font-size:clamp(14px,2.3vw,16px);
    line-height:1.9;
    max-width:620px;
    margin:0 auto 12px;
    letter-spacing:.2px;
  }
  @media (max-width:600px){
    .title{margin:40px 0 18px}
    h1{margin:10px 0 16px}
    .lead{margin-bottom:18px}
  }

  /* デザイン選択カルーセル */
  .design-section{
    max-width:520px;
    width:92%;
    margin:0 auto;
  }

  .carousel{
    width:100%;
    margin:12px auto 10px;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    scroll-snap-type:x mandatory;
    padding-bottom:8px;
  }

  .design-track{
    display:flex;
    gap:20px;
    padding:4px 2px 36px; /* 下にCOMING SOONバッジの分の余白 */
  }

  .design-card{
    position:relative;
    flex:0 0 46vw;
    max-width:260px;
    background:transparent;
    padding:0;
    scroll-snap-align:center;
    cursor:pointer;
    border:0.5px solid #ccc;
    border-radius:0;
    transition:border-color .15s ease, transform .15s ease;
  }

  .design-card:hover{
    transform:translateY(-1px);
  }

  .design-card.active{
    border:3px solid var(--pink);
  }

  .design-thumb{
    width:100%;
    margin:0;
  }
  .design-thumb img{
    width:100%;
    height:auto;
    display:block;
    border-radius:0;
  }

  /* COMING SOON */
  .design-card.coming-soon{
    pointer-events:none;
    border-color:#ccc; border-width:0.5px;
  }
  .design-card.coming-soon img{
    opacity:0.9;
    filter:grayscale(0.25);
  }

  .design-card.coming-soon::after{
    content:"COMING SOON";
    position:absolute;
    left:50%;
    bottom:-26px;
    transform:translateX(-50%);
    padding:4px 10px;
    border-radius:0;
    background:none;
    color:#000;
    font-weight:700;
    font-size:11px;
    letter-spacing:.16em;
    text-align:center;
    white-space:nowrap;
    box-shadow:none;
  }

  /* footer */
  .footer{
    background:transparent;
    padding:12px 8px calc(36px + var(--safe-bottom));
    margin-top:18px;
  }
  .row{display:flex;gap:12px;justify-content:space-between}
  .btn{
    flex:1;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    padding:16px 20px;
    border-radius:14px;
    border:1px solid #eee;
    background:#fff;
    color:#333;
    box-shadow:0 10px 24px rgba(0,0,0,.05);
    font-size:15px;
  }
  .btn-prim{
    background:var(--grad);
    color:#fff;
    border:none;
    box-shadow:0 12px 28px rgba(240,141,176,.25);
    font-weight:800;
    letter-spacing:.02em;
  }
  .btn:active{transform:translateY(1px)}
</style>
</head>
<body>
<div class="wrap">
  <header class="header">
    <div class="logo" aria-hidden="true">
      <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="var(--pink)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="8" width="18" height="12" rx="2"/>
        <path d="M12 8v12"/><path d="M3 12h18"/>
        <path d="M7.5 6a2.5 2.5 0 1 1 5 0v2h-5V6z"/>
        <path d="M11.5 6a2.5 2.5 0 1 1 5 0v2h-5V6z"/>
      </svg>
    </div>
    <div class="brand">えらべるギフト</div>
  </header>

  <main class="main">
    <section class="title">
      <h1>送るデザインをえらぶ</h1>
      <p class="lead">
        カタログを届けるときのデザインを選べます。<br>
        ぴったりの雰囲気をえらんでください。
      </p>
    </section>

    <section class="design-section" aria-label="送るデザインの選択">
      <div class="carousel">
        <div class="design-track">
          <article class="design-card" data-index="1" data-available="true">
            <div class="design-thumb">
              <img src="/assets/design1.png" alt="デザイン1プレビュー">
            </div>
          </article>

          <article class="design-card" data-index="2" data-available="true">
            <div class="design-thumb">
              <img src="/assets/design2.png" alt="デザイン2プレビュー">
            </div>
          </article>

          <article class="design-card coming-soon" data-index="3" data-available="false">
            <div class="design-thumb">
              <img src="/assets/design3.png" alt="デザイン3プレビュー">
            </div>
          </article>

          <article class="design-card coming-soon" data-index="4" data-available="false">
            <div class="design-thumb">
              <img src="/assets/design4.png" alt="デザイン4プレビュー">
            </div>
          </article>

          <article class="design-card coming-soon" data-index="5" data-available="false">
            <div class="design-thumb">
              <img src="/assets/design5.png" alt="デザイン5プレビュー">
            </div>
          </article>

          <article class="design-card coming-soon" data-index="6" data-available="false">
            <div class="design-thumb">
              <img src="/assets/design6.png" alt="デザイン6プレビュー">
            </div>
          </article>

          <article class="design-card coming-soon" data-index="7" data-available="false">
            <div class="design-thumb">
              <img src="/assets/design7.png" alt="デザイン7プレビュー">
            </div>
          </article>

          <article class="design-card coming-soon" data-index="8" data-available="false">
            <div class="design-thumb">
              <img src="/assets/design8.png" alt="デザイン8プレビュー">
            </div>
          </article>

          <article class="design-card coming-soon" data-index="9" data-available="false">
            <div class="design-thumb">
              <img src="/assets/design9.png" alt="デザイン9プレビュー">
            </div>
          </article>

        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="row">
      <button class="btn" type="button" id="backBtn">戻る</button>
      <button class="btn btn-prim" type="button" id="nextBtn">次へ</button>
    </div>
  </footer>
</div>

<script>
/* ===== URL パラメータ保持セットアップ ===== */
    const srcParams = new URLSearchParams(location.search);

    // 引き継ぎたいキーを書いておく（必要に応じて増減OK）
    const KEEP = [];

    // 遷移先URLを生成する関数
    function buildUrl(nextPage){
    const sp = new URLSearchParams();
    KEEP.forEach(k=>{
        if(srcParams.has(k)){
        sp.set(k, srcParams.get(k));
        }
    });
    const qs = sp.toString();
    return qs ? `${nextPage}?${qs}` : nextPage;
    }


/* ===============================
   画面高さ補正
================================== */
function setVH() {
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', vh + 'px');
}
setVH();
window.addEventListener('resize', setVH, { passive: true });
window.addEventListener('orientationchange', setVH);

/* ===============================
   localStorage 共通関数
================================== */
const DRAFT_KEY  = "giftDraft_v1";  // 編集途中
const MASTER_KEY = "eraberuGift";   // 完成データ

function loadDraft() {
  try {
    return JSON.parse(localStorage.getItem(DRAFT_KEY) || "{}");
  } catch (e) {
    console.error("loadDraft error", e);
    return {};
  }
}
function saveDraft(patch) {
  const current = loadDraft();
  const next = Object.assign({}, current, patch || {});
  try {
    localStorage.setItem(DRAFT_KEY, JSON.stringify(next));
  } catch (e) {
    console.error("saveDraft error", e);
  }
}
function saveMaster(master) {
  try {
    localStorage.setItem(MASTER_KEY, JSON.stringify(master));
  } catch (e) {
    console.error("saveMaster error", e);
  }
}

/* ===============================
   draft → 統一フォーマットへ変換
   （gift1Name / gift1Img / gift1Reason などを生成）
================================== */

/** index(1〜3)に対応するURLを取得（draft内） */
function getUrlForIndexFromDraft(draft, index) {
  const keys = ["url" + index, "link" + index, "productUrl" + index];
  for (var i = 0; i < keys.length; i++) {
    var k = keys[i];
    var v = draft[k];
    if (typeof v === "string" && v.trim()) return v.trim();
  }
  return "";
}

/** perUrl[urlKey] を安全に取得 */
function getPerUrlEntry(draft, index) {
  if (!draft.perUrl || typeof draft.perUrl !== "object") {
    return { urlKey: "slot" + index, data: null };
  }
  var url = getUrlForIndexFromDraft(draft, index);
  var urlKey = url || ("slot" + index);
  var data = draft.perUrl[urlKey] || null;
  return { urlKey: urlKey, data: data };
}

/** giftDraft_v1 を master 用の gift{n}XXX に正規化 */
function normalizeGiftsFromDraft(draft) {
  var normalized = {};

  for (var i = 1; i <= 3; i++) {
    var title = "";
    var desc  = "";
    var img   = "";
    var reason = "";

    // perUrl 側
    var perInfo = getPerUrlEntry(draft, i);
    var per = perInfo.data;
    if (per) {
      if (typeof per.title === "string" && per.title.trim()) {
        title = per.title.trim();
      }
      if (typeof per.desc === "string" && per.desc.trim()) {
        desc = per.desc.trim();
      }
      if (typeof per.imgData === "string" && per.imgData) {
        img = per.imgData;
      }
    }

    // 旧仕様の title1 / desc1 など（残っていれば上書き）
    var legacyTitleKey = "title" + i;
    var legacyDescKey  = "desc" + i;
    if (!title && typeof draft[legacyTitleKey] === "string" && draft[legacyTitleKey].trim()) {
      title = draft[legacyTitleKey].trim();
    }
    if (!desc && typeof draft[legacyDescKey] === "string" && draft[legacyDescKey].trim()) {
      desc = draft[legacyDescKey].trim();
    }

    // 選んだ理由（selectreason.html 側で reason1 / reason2 / reason3 に保存している想定）
    var reasonKey = "reason" + i;
    if (typeof draft[reasonKey] === "string" && draft[reasonKey].trim()) {
      reason = draft[reasonKey].trim();
    }

    normalized["gift" + i + "Name"]   = title;
    normalized["gift" + i + "Desc"]   = desc;
    normalized["gift" + i + "Img"]    = img;
    normalized["gift" + i + "Reason"] = reason;
  }

  return normalized;
}

/* ===============================
   デザイン選択 UI
================================== */
const cards = document.querySelectorAll('.design-card');
let selectedIndex = 1;

function updateActiveUI() {
  cards.forEach(card => {
    const idx = Number(card.dataset.index);
    card.classList.toggle("active", idx === selectedIndex);
  });
}

function restoreSelected() {
  const draft = loadDraft();
  const idx = Number(draft.sendDesignIndex);
  if (!Number.isNaN(idx) && idx > 0) {
    selectedIndex = idx;
  }
  updateActiveUI();
}

cards.forEach(card => {
  card.addEventListener("click", () => {
    if (card.dataset.available !== "true") return;
    selectedIndex = Number(card.dataset.index);
    updateActiveUI();
    saveDraft({ sendDesignIndex: selectedIndex });
  });
});

restoreSelected();

/* ===============================
   「次へ」＝ master データ確定
================================== */
document.getElementById("nextBtn").addEventListener("click", () => {
  try {
    // デザイン番号を draft に保存（未操作でも1が入る）
    saveDraft({ sendDesignIndex: selectedIndex });

    const draft = loadDraft();

    // catalogId がなければ発行
    let catalogId = draft.catalogId;
    if (!catalogId) {
      if (window.crypto && window.crypto.randomUUID) {
        catalogId = "gift-" + window.crypto.randomUUID().slice(0, 8);
      } else {
        catalogId = "gift-" + Date.now().toString(36);
      }
    }

    // 写真URL（DataURL含む）を master 用に決定
    const photoUrl =
      draft.messagePhotoUrl ||   // すでに URL があれば優先
      draft.photoUrl ||
      draft.messagePhotoData ||  // message.html で保存した DataURL
      "";

    // 商品データを統一フォーマットへ変換
    const normalizedGifts = normalizeGiftsFromDraft(draft);

    // 共有URL（受け取り側のカタログ画面）
    const shareUrl = (location.origin || "") +
      "/giftcatalogopen.html?id=" + encodeURIComponent(catalogId);

    // master に確定保存
    const masterBase = Object.assign({}, draft, normalizedGifts, {
      catalogId: catalogId,
      giftId: catalogId,
      shareUrl: shareUrl,
      messagePhotoUrl: photoUrl, // DataURL or 画像URL
      createdAt: Date.now()
    });

    saveMaster(masterBase);

    // draft 側にも catalogId を反映（再編集用）
    saveDraft({ catalogId: catalogId });

    // makelink へ
    window.location.href = buildUrl("makelink.html");
  } catch (e) {
    console.error("次へクリック時のエラー", e);
    // 何かあっても一応遷移だけは試みる
    window.location.href = buildUrl("makelink.html");
  }
});

/* ===============================
   「戻る」
================================== */
document.getElementById("backBtn").addEventListener("click", () => {
  if (document.referrer) {
    history.back();
  } else {
    window.location.href = buildUrl("selectreason.html");
  }
});

</script>

</body>
</html>
