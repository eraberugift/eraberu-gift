<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>写真・メッセージの追加 | えらべるギフト</title>
<link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">

<style>
  :root{
    /* === tokens === */
    --pink:#f58fb1; --ink:#2a2a2a; --muted:#6b7280;
    --bg-top:#fff1f6; --bg-bottom:#fde9d3;
    --grad:linear-gradient(90deg,#f08db0 0%,#f2b35e 100%);
    --card-bg:#fff; --shadow:0 14px 30px rgba(0,0,0,.08); --radius:20px;
    --safe-bottom: env(safe-area-inset-bottom, 0px);

    /* 高さ（iOS対策） */
    --vh:1svh;
    --screenH:calc(var(--vh) * 100);
  }

  *{box-sizing:border-box;}
  html,body{min-height:100vh;height:auto;}
  body{
    margin:0;
    font-family:"Kosugi Maru","Hiragino Maru Gothic ProN","Hiragino Sans","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    color:var(--ink);
    background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom)) fixed;
    background-size:100% 100%;
  }
  a{color:inherit;text-decoration:none;}

  .wrap{
    max-width:960px;
    margin:0 auto;
    padding:16px 16px 0;
    min-height:var(--screenH);
    display:flex;
    flex-direction:column;
  }
  .main{flex:1;display:flex;flex-direction:column;}

  /* header */
  .header{display:flex;align-items:center;gap:12px;padding-top:4px;}
  .logo{width:32px;height:32px;display:flex;align-items:center;justify-content:center;}
  .brand{font-weight:800;font-size:22px;color:var(--pink);letter-spacing:.02em;}

  /* title */
  .title{text-align:center;margin:26px 0 14px;}
  h1{
    font-size:clamp(22px,6.2vw,32px);
    line-height:1.25;
    margin:8px 0 12px;
  }
  .lead{
    color:var(--muted);
    text-align:center;
    font-size:clamp(14px,2.3vw,16px);
    line-height:1.9;
    max-width:620px;
    margin:0 auto 12px;
    letter-spacing:.2px;
  }
  @media (max-width:600px){
    .title{margin:40px 0 18px;}
    h1{margin:10px 0 16px;}
    .lead{margin-bottom:18px;}
  }

  /* block（カード全体） */
  .block{
    background:rgba(255,255,255,.96);
    border-radius:var(--radius);
    box-shadow:0 10px 24px rgba(0,0,0,.04);
    padding:22px 18px 22px;
    max-width:520px;
    width:92%;
    margin:0 auto 18px;
  }

  .field{
    margin-bottom:24px;
  }
  .field:last-child{
    margin-bottom:0;
  }

  .field-label-row{
    display:flex;
    align-items:center;
    gap:6px;
    margin-bottom:14px;
    font-size:14px;
  }
  .field-label-main{
    font-weight:700;
  }
  .field-optional{
    font-size:13px;
    color:var(--muted);
  }

  .field-photo .field-label-row{
    margin-bottom:12px;
  }
  .field-photo .field-help{
    margin:0 0 18px;
    font-size:13px;
    color:var(--muted);
  }

  .field-help{
    margin:0 0 10px;
    font-size:12px;
    color:var(--muted);
  }

  /* テキスト入力共通 */
  .text-input{
    width:100%;
    border-radius:12px;
    border:1px solid #e5d4d8;
    padding:10px 12px;
    font-family:inherit;
    font-size:14px;
    line-height:1.5;
    outline:none;
    background:#fff;
  }
  .text-input::placeholder{
    color:#b8a9ac;
  }

  /* 写真アップロードエリア */
  .upload-area{
    position:relative;
    width:100%;
    aspect-ratio:1 / 1;
    border-radius:18px;
    border:2px dashed #f6bcd0;
    background:#fff;
    cursor:pointer;
    overflow:hidden;
    transition:border-color .15s, box-shadow .15s, background-color .15s;
  }
  .upload-area:hover{
    border-color:#f58fb1;
    box-shadow:0 8px 18px rgba(245,143,177,.12);
  }

  .upload-placeholder,
  .upload-preview{
    position:absolute;
    inset:0;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
  }

  .upload-placeholder{
    gap:10px;
    padding:24px;
    text-align:center;
  }

  .upload-icon{
    width:40px;height:40px;
    border-radius:999px;
    background:#fff7f9;
    display:flex;
    align-items:center;
    justify-content:center;
    margin-bottom:4px;
  }
  .upload-text-main{
    font-size:15px;
    font-weight:700;
  }
  .upload-text-sub{
    font-size:12px;
    color:var(--muted);
    line-height:1.7;
  }

  .upload-preview{
    display:none;
  }
  .upload-preview img{
    width:100%;
    height:100%;
    object-fit:cover;
  }

  .upload-area.has-image{
    border-color:transparent;
    box-shadow:none;
  }

  /* メッセージエリア */
  .message-card{
    border-radius:16px;
    background:#fff7ea;
    padding:10px 12px;
  }
  .message-card textarea{
    width:100%;
    border:none;
    background:transparent;
    resize:vertical;
    min-height:90px;
    max-height:240px;
    font-family:inherit;
    font-size:14px;
    line-height:1.7;
    color:var(--ink);
    outline:none;
  }
  .message-card textarea::placeholder{
    color:#c4a98a;
  }

  /* footer */
  .footer{
    background:transparent;
    padding:12px 8px calc(36px + var(--safe-bottom));
    margin-top:18px;
  }
  .row{display:flex;gap:12px;justify-content:space-between;}
  .btn{
    flex:1;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    padding:16px 20px;
    border-radius:14px;
    border:1px solid #eee;
    background:#fff;
    color:#333;
    box-shadow:0 10px 24px rgba(0,0,0,.05);
    font-size:15px;
  }
  .btn-prim{
    background:var(--grad);
    color:#fff;
    border:none;
    box-shadow:0 12px 28px rgba(240,141,176,.25);
    font-weight:800;
    letter-spacing:.02em;
  }
  .btn:active{transform:translateY(1px);}
</style>
</head>
<body>
<div class="wrap">
  <header class="header">
    <div class="logo" aria-hidden="true">
      <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="var(--pink)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="8" width="18" height="12" rx="2"/>
        <path d="M12 8v12"/><path d="M3 12h18"/>
        <path d="M7.5 6a2.5 2.5 0 1 1 5 0v2h-5V6z"/>
        <path d="M11.5 6a2.5 2.5 0 1 1 5 0v2h-5V6z"/>
      </svg>
    </div>
    <div class="brand">えらべるギフト</div>
  </header>

  <main class="main">
    <section class="title">
      <h1>写真・メッセージを添える</h1>
      <p class="lead">
        ギフトと一緒に、思い出の写真や<br>
        ひとことメッセージを添えることができます
      </p>
    </section>

    <!-- 写真・メッセージのブロック -->
    <section class="block" aria-label="写真とメッセージの入力エリア">
      <!-- 写真 -->
      <div class="field field-photo">
        <div class="field-label-row">
          <div class="field-label-main">写真を追加</div>
          <span class="field-optional">（任意）</span>
        </div>
        <p class="field-help">思い出の写真を1枚まで添えられます。</p>

        <div class="upload-wrapper">
          <input id="photoInput" type="file" accept="image/*" style="display:none" />

          <div id="uploadArea" class="upload-area" role="button" tabindex="0" aria-label="写真を選択">
            <div class="upload-placeholder">
              <div class="upload-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 16V4"/><path d="M7 9l5-5 5 5"/><path d="M4 16v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2"/>
                </svg>
              </div>
              <div class="upload-text-main">クリックして写真を選択</div>
            </div>

            <div class="upload-preview" aria-hidden="true"></div>
          </div>
        </div>
      </div>

      <!-- 宛名・送り主 -->
      <div class="field">
        <div class="field-label-row">
          <div class="field-label-main">宛名</div>
          <span class="field-optional">（任意）</span>
        </div>
        <input
          id="toInput"
          class="text-input"
          type="text"
          inputmode="text"
          autocomplete="off"
          placeholder="例：太郎"
        />
      </div>

      <!-- メッセージ本文 -->
      <div class="field">
        <div class="field-label-row">
          <div class="field-label-main">メッセージ</div>
          <span class="field-optional">（任意）</span>
        </div>

        <div class="message-card">
          <textarea id="messageInput"
            placeholder="相手へのメッセージを書いてください…"></textarea>
        </div>
      </div>

      <div class="field">
        <div class="field-label-row">
          <div class="field-label-main">送り主</div>
          <span class="field-optional">（任意）</span>
        </div>
        <input
          id="fromInput"
          class="text-input"
          type="text"
          inputmode="text"
          autocomplete="off"
          placeholder="例：花子"
        />
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="row">
      <button class="btn" type="button" id="backBtn">戻る</button>
      <button class="btn btn-prim" type="button" id="nextBtn">次へ</button>
    </div>
  </footer>
</div>

<script>
/* ===== URL パラメータ保持セットアップ ===== */
    const srcParams = new URLSearchParams(location.search);

    // 引き継ぐキー（必要に応じて増やせる）
    const KEEP = ["id","preview","egift"];

    // 画面遷移URLを作る関数
    function buildUrl(nextPage){
    const sp = new URLSearchParams();
    KEEP.forEach(k=>{
        if(srcParams.has(k)){
        sp.set(k, srcParams.get(k));
        }
    });
    const qs = sp.toString();
    return qs ? `${nextPage}?${qs}` : nextPage;
    }


  /* ===== iOS対策：実高さを CSS 変数に反映 ===== */
  function setVH() {
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', vh + 'px');
  }
  setVH();
  window.addEventListener('resize', setVH, { passive:true });
  window.addEventListener('orientationchange', setVH);

  /* ====== localStorage セットアップ ====== */
  const FORM_KEY = "giftDraft_v1";
  let draft = {};
  try{
    const raw = localStorage.getItem(FORM_KEY);
    if(raw){
      draft = JSON.parse(raw) || {};
    }
  }catch(e){
    draft = {};
  }
  function saveDraft(){
    try{
      localStorage.setItem(FORM_KEY, JSON.stringify(draft));
    }catch(e){
      console.error("localStorage save error", e);
    }
  }

  const photoInput        = document.getElementById('photoInput');
  const uploadArea        = document.getElementById('uploadArea');
  const uploadPreview     = uploadArea.querySelector('.upload-preview');
  const uploadPlaceholder = uploadArea.querySelector('.upload-placeholder');
  const messageInput      = document.getElementById('messageInput');
  const toInput           = document.getElementById('toInput');
  const fromInput         = document.getElementById('fromInput');

  let currentImageDataUrl = null;

  function showPhoto(dataUrl){
    uploadPreview.innerHTML = '<img src="'+ dataUrl +'" alt="選択した写真">';
    uploadPreview.style.display = 'flex';
    uploadPlaceholder.style.display = 'none';
    uploadArea.classList.add('has-image');
  }

  function resetPhoto(){
    currentImageDataUrl = null;
    photoInput.value = '';
    uploadPreview.innerHTML = '';
    uploadPreview.style.display = 'none';
    uploadPlaceholder.style.display = 'flex';
    uploadArea.classList.remove('has-image');
  }

  /* ===== ページ初期表示：保存済みデータを復元 ===== */
  // 写真
  if (draft.messagePhotoData && typeof draft.messagePhotoData === 'string') {
    currentImageDataUrl = draft.messagePhotoData;
    showPhoto(currentImageDataUrl);
  }
  // メッセージ本文
  if (draft.messageText && typeof draft.messageText === 'string') {
    messageInput.value = draft.messageText;
  }
  // 宛名
  if (draft.messageTo && typeof draft.messageTo === 'string') {
    toInput.value = draft.messageTo;
  }
  // 送り主
  if (draft.messageFrom && typeof draft.messageFrom === 'string') {
    fromInput.value = draft.messageFrom;
  }

  /* ===== 写真アップロード処理（localStorage 保存付き） ===== */
  function openFilePicker() {
    photoInput.click();
  }

  uploadArea.addEventListener('click', openFilePicker);
  uploadArea.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      openFilePicker();
    }
  });

  photoInput.addEventListener('change', ()=>{
    const file = photoInput.files[0];
    if(!file){
      // キャンセルされた場合は既存の画像を維持
      if(!currentImageDataUrl){
        resetPhoto();
      }
      return;
    }
    const reader = new FileReader();
    reader.onload = (e)=>{
      currentImageDataUrl = e.target.result;
      showPhoto(currentImageDataUrl);

      // localStorage に保存
      draft.messagePhotoData = currentImageDataUrl;
      saveDraft();
    };
    reader.readAsDataURL(file);
  });

  /* ===== テキスト入力（localStorage 保存） ===== */
  messageInput.addEventListener('input', ()=>{
    draft.messageText = messageInput.value;
    saveDraft();
  });

  toInput.addEventListener('input', ()=>{
    draft.messageTo = toInput.value;
    saveDraft();
  });

  fromInput.addEventListener('input', ()=>{
    draft.messageFrom = fromInput.value;
    saveDraft();
  });

  /* ===== 戻る / 次へ ===== */
  document.getElementById('backBtn').addEventListener('click', ()=>{
    if (document.referrer) {
        history.back();
    } else {
        window.location.href = buildUrl("confirm.html");
    }
    });

    document.getElementById('nextBtn').addEventListener('click', ()=>{
    draft.messageText      = messageInput.value;
    draft.messageTo        = toInput.value;
    draft.messageFrom      = fromInput.value;
    draft.messagePhotoData = currentImageDataUrl || draft.messagePhotoData || "";
    saveDraft();

    window.location.href = buildUrl("selectreason.html");
    });

</script>
</body>
</html>
