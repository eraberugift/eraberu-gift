<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>選択が完了しました | えらべるギフト</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #f1ece8;
      --ink: #2b2b2b;
      --muted: #7a7268;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --card-w: min(340px, 82vw);
    }

    *{ box-sizing:border-box; }

    /* ▼ フェードイン ▼ */
    body{
      margin:0;
      background:var(--bg);
      font-family:"Noto Sans JP","Hiragino Sans","-apple-system",system-ui,sans-serif;
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      opacity:0;
      transition: opacity .9s ease;
    }
    body.is-visible{
      opacity:1;
    }
    /* ▲ フェードイン ▲ */

    .app{
      max-width:480px;
      margin:0 auto;
      padding:24px 16px calc(24px + var(--safe-bottom));
    }

    .header{
      text-align:center;
      margin-bottom:32px;
    }

    .title{
      font-size:26px;
      letter-spacing:.16em;
      text-transform:uppercase;
      font-weight:700;
    }

    .caption{
      margin-top:6px;
      font-size:11px;
      letter-spacing:.1em;
      text-transform:uppercase;
      color:var(--muted);
    }

    /* ===== メインメッセージ ===== */
    .message{
      max-width:var(--card-w);
      margin:0 auto 10px;
      text-align:center;
    }

    .done-text{
      font-size:13px;
      line-height:1.9;
      color:var(--muted);
      margin:0 0 14px;
    }

    .chosen-label{
      margin:24px 0 4px;
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:var(--muted);
    }

    .chosen-name{
      margin:0;
      font-size:15px;
      font-weight:600;
      line-height:1.5;
    }

    /* ===== 写真枠 ===== */
    .photo-block{
      max-width:var(--card-w);
      margin:10px auto 24px;
    }

    .photo-frame{
      width:100%;
      aspect-ratio:1 / 1;
      display:flex;
      align-items:center;
      justify-content:center;
      background:transparent;
      border:none;
      overflow:visible;
      position:relative;
    }

    .photo-frame img{
      width:86%;
      height:86%;
      object-fit:cover;
      background:#fff;
      border:1px solid #111;
      box-sizing:border-box;
      display:block;
      filter:
        saturate(0.9)
        contrast(0.85)
        brightness(1.03);
    }

    .photo-frame::after{
      content:"";
      position:absolute;
      inset:7%;
      pointer-events:none;
      mix-blend-mode:soft-light;
      opacity:.6;
      background-image:
        radial-gradient(circle at 0 0, rgba(0,0,0,.18) 0, transparent 55%),
        radial-gradient(circle at 100% 0, rgba(0,0,0,.12) 0, transparent 55%),
        radial-gradient(circle at 0 100%, rgba(0,0,0,.14) 0, transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(0,0,0,.16) 0, transparent 55%);
      background-size:18px 18px;
    }

    /* ===== CTA（LINE公式アカウント） ===== */
    .cta{
      max-width:var(--card-w);
      margin:0 auto;
      text-align:center;
    }

    .cta-text{
      font-size:12px;
      line-height:1.8;
      margin:0 0 18px;
      color:var(--muted);
    }

    .btn-line{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:11px 24px;
      border-radius:999px;
      border:none;
      background:#000;
      color:#fff;
      font-size:13px;
      font-weight:600;
      letter-spacing:.12em;
      text-transform:uppercase;
      cursor:pointer;
    }
    .btn-line:active{
      transform:translateY(1px);
    }

    .btn-line-icon{
      font-size:14px;
      line-height:1;
    }
  </style>
</head>
<body>

  <div class="app">
    <header class="header">
      <div class="title">ERABERU GIFT</div>
      <div class="caption">THANK YOU FOR CHOOSING</div>
    </header>

    <main>
      <section class="message">
        <p class="done-text">
          あなたがえらんだギフトの内容が、<br>
          贈り主に通知されました。
        </p>
        <p class="chosen-label">SELECTED GIFT</p>
        <p class="chosen-name" id="giftName">
          （ここに選ばれた商品名が入ります）
        </p>
      </section>

      <section class="photo-block">
        <div class="photo-frame">
          <!-- 選ばれた商品の写真 -->
          <img id="giftImage"
               src="https://images.pexels.com/photos/4465125/pexels-photo-4465125.jpeg?auto=compress&cs=tinysrgb&w=800"
               alt="選ばれたギフトの写真">
        </div>
      </section>

      <section class="cta">
        <p class="cta-text">
          えらべるギフトをご利用いただきありがとうございました。<br>
          あなたも、誰かのためにカタログを作ってみませんか？
        </p>
        <button class="btn-line" type="button" id="lineButton">
          <span class="btn-line-icon">＋</span>
          <span>LINE公式アカウントを登録する</span>
        </button>
      </section>
    </main>
  </div>

  <script>
    // master 読み込み
    function loadState(){
      try{
        return JSON.parse(localStorage.getItem("eraberuGift") || "{}");
      }catch(e){
        return {};
      }
    }

    // master から URL を推定（perUrl 用）
    function getUrlForIndex(state, index){
      if (!state) return "";
      const candidates = ["url"+index, "link"+index, "productUrl"+index];
      for (const key of candidates){
        const v = state[key];
        if (typeof v === "string" && v.trim()){
          return v.trim();
        }
      }
      return "";
    }

    // master.perUrl から entry を取る
    function getPerUrlEntry(state, index){
      if (!state || !state.perUrl || typeof state.perUrl !== "object") return null;
      const url    = getUrlForIndex(state, index);
      const urlKey = url || ("slot" + index);
      const entry  = state.perUrl[urlKey];
      return entry || null;
    }

    window.addEventListener("DOMContentLoaded", () => {
      requestAnimationFrame(() => {
        document.body.classList.add("is-visible");
      });

      const nameEl = document.getElementById("giftName");
      const imgEl  = document.getElementById("giftImage");

      const params = new URLSearchParams(location.search);

      // 1) eraberuGift_selected の読み込み（選択画面で書き込んだもの）
      let selected = null;
      try{
        selected = JSON.parse(localStorage.getItem("eraberuGift_selected") || "null");
      }catch(e){
        selected = null;
      }

      // 2) giftId の決定（URL > selected > master > デフォルト1）
      let giftId = params.get("giftId");

      if (!/^[1-3]$/.test(giftId || "")){
        if (selected && /^[1-3]$/.test(selected.giftId || "")){
          giftId = selected.giftId;
        } else {
          const master = loadState();
          if (master.giftId && /^[1-3]$/.test(String(master.giftId))){
            giftId = String(master.giftId);
          } else if (master.selectedGiftIndex && /^[1-3]$/.test(String(master.selectedGiftIndex))){
            giftId = String(master.selectedGiftIndex);
          } else {
            giftId = "1";
          }
        }
      }

      const index = parseInt(giftId, 10); // 1 / 2 / 3

      const master = loadState();
      const per    = getPerUrlEntry(master, index);

      // 3) master から名前・画像を再構築（giftId に紐づいた真の情報）
      const nameFromMaster =
        master[`gift${index}Name`] ||
        (per && per.title)        ||
        master[`title${index}`]   ||
        master.selectedGiftName   || "";

      const imgFromMaster =
        master[`gift${index}Img`] ||
        (per && per.imgData)      ||
        master.selectedGiftImg    || "";

      // 4) 最終的な名前の決定（master > selected > URLクエリgift）
      const giftNameFromQuery = params.get("gift"); // 旧形式の互換用
      const finalName =
        nameFromMaster ||
        (selected && selected.giftName) ||
        giftNameFromQuery ||
        "";

      if (finalName){
        nameEl.textContent = finalName;
      }

      // 5) 最終的な画像URLの決定（master > selected > URLクエリimg）
      const imgFromQuery = params.get("img"); // 旧形式の互換用
      const finalImg =
        imgFromMaster ||
        (selected && selected.giftImg) ||
        imgFromQuery ||
        "";

      if (finalImg){
        imgEl.src = finalImg;
      }

      // alt テキストも最終名に合わせる
      if (finalName){
        imgEl.alt = finalName + " の写真";
      }else{
        imgEl.alt = "選ばれたギフトの写真";
      }
    });

    document.getElementById("lineButton").addEventListener("click", () => {
      // TODO: 実際のLINE公式アカウントURLに差し替え
      alert("LINE公式アカウントのURLをここに設定してください。");
    });
  </script>

</body>
</html>
