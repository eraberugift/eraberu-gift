<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ギフトカタログを作る | えらべるギフト</title>
<link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">

<style>
  :root{
    --pink:#f58fb1; --ink:#2a2a2a; --muted:#6b7280;
    --bg-top:#fff1f6; --bg-bottom:#fde9d3;
    --grad:linear-gradient(90deg,#f08db0 0%,#f2b35e 100%);
    --card-bg:#fff; --shadow:0 14px 30px rgba(0,0,0,.08); --radius:18px;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --vh: 1svh;
    --screenH: calc(var(--vh) * 100);
  }

  *{box-sizing:border-box;}
  html,body{min-height:100vh;height:auto;}
  body{
    margin:0;
    font-family:"Kosugi Maru","Hiragino Maru Gothic ProN","Hiragino Sans","Noto Sans JP",system-ui,-apple-system;
    color:var(--ink);
    background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom)) fixed;
    background-size:100% 100%;
  }
  a{color:inherit;text-decoration:none;}

  .wrap{
    max-width:960px;
    margin:0 auto;
    padding:16px 16px 0;
    min-height:var(--screenH);
    display:flex;
    flex-direction:column;
  }
  .main{flex:1;display:flex;flex-direction:column;}

  .header{display:flex;align-items:center;gap:12px;padding-top:4px;}
  .brand{font-weight:800;font-size:22px;color:var(--pink);}

  .title{text-align:center;margin:20px 0 12px;}
  h1{font-size:clamp(22px,6.2vw,30px);line-height:1.25;margin:8px 0 10px;}
  .lead{
    color:var(--muted);text-align:center;
    font-size:clamp(14px,2.3vw,16px);
    line-height:1.9;max-width:620px;margin:0 auto 12px;
  }

  .form-card{
    background:var(--card-bg);border-radius:var(--radius);box-shadow:var(--shadow);
    padding:18px 18px 6px;max-width:520px;width:92%;margin:0 auto 24px;
  }

  .product-block{padding:12px 0 16px;}
  .product-block + .product-block{border-top:1px solid #f1f1f3;margin-top:4px;}
  .product-title{font-weight:700;margin-bottom:6px;font-size:14px;}

  .field{margin-bottom:12px;}
  .field-label{font-size:13px;margin-bottom:4px;display:flex;gap:4px;}
  .req{color:var(--pink);font-size:12px;}

  .field input{
    width:100%;border-radius:10px;border:1px solid #e5e7eb;
    padding:11px 12px;font-size:14px;background:#fff;
  }
  .field input:focus{
    outline:none;border-color:#f9a8c7;box-shadow:0 0 0 1px rgba(245,143,177,.35);
  }

  .footer{padding:10px 4px calc(36px + var(--safe-bottom));margin-top:4px;}
  .btn{
    width:100%;padding:16px 20px;border-radius:14px;background:var(--grad);
    color:#fff;font-size:15px;font-weight:800;box-shadow:0 12px 28px rgba(240,141,176,.25);
    cursor:pointer;border:none;
  }
</style>
</head>

<body>
<div class="wrap">
  <header class="header">
    <div class="logo" aria-hidden="true">
      <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="var(--pink)" stroke-width="2">
        <rect x="3" y="8" width="18" height="12" rx="2"/>
        <path d="M12 8v12"/><path d="M3 12h18"/>
        <path d="M7.5 6a2.5 2.5 0 1 1 5 0v2h-5V6z"/>
        <path d="M11.5 6a2.5 2.5 0 1 1 5 0v2h-5V6z"/>
      </svg>
    </div>
    <div class="brand">えらべるギフト</div>
  </header>

  <main class="main">
    <section class="title">
      <h1>ギフトカタログを作る</h1>
      <p class="lead">大切な人に3つの商品から選んでもらえる<br>特別なギフトを作りましょう</p>
    </section>

    <form id="giftForm" class="form-card">

      <div class="product-block">
        <div class="product-title">商品1</div>
        <div class="field">
          <div class="field-label">商品タイトル<span class="req">＊</span></div>
          <input type="text" name="title1" required>
        </div>
        <div class="field">
          <div class="field-label">商品URL<span class="req">＊</span></div>
          <input type="url" name="url1" required>
        </div>
      </div>

      <div class="product-block">
        <div class="product-title">商品2</div>
        <div class="field">
          <div class="field-label">商品タイトル</div>
          <input type="text" name="title2">
        </div>
        <div class="field">
          <div class="field-label">商品URL</div>
          <input type="url" name="url2">
        </div>
      </div>

      <div class="product-block">
        <div class="product-title">商品3</div>
        <div class="field">
          <div class="field-label">商品タイトル</div>
          <input type="text" name="title3">
        </div>
        <div class="field">
          <div class="field-label">商品URL</div>
          <input type="url" name="url3">
        </div>
      </div>

    </form>

    <footer class="footer">
      <button class="btn" form="giftForm">カタログを作成する</button>
    </footer>
  </main>
</div>

<script>
// ========= 1. iOS viewport =========
function setVH(){
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
setVH();
window.addEventListener('resize', setVH);

// ========= 2. 草稿保存 =========
const FORM_KEY = "giftDraft_v1";
const DRAFT_URLS_KEY = "draftUrls";
const CATALOG_ID_KEY = "catalogId";

function saveDraft(){
  const data = Object.fromEntries(new FormData(document.getElementById("giftForm")).entries());
  localStorage.setItem(FORM_KEY, JSON.stringify(data));
}
function loadDraft(){
  const saved = localStorage.getItem(FORM_KEY);
  if(!saved) return;
  const data = JSON.parse(saved);
  Object.entries(data).forEach(([k,v])=>{
    const input = document.querySelector(`[name="${k}"]`);
    if(input) input.value = v;
  });
}
loadDraft();
document.querySelectorAll("#giftForm input").forEach(i=>{
  i.addEventListener("input", () => {
    saveDraft();
    checkUrlUpdate();
  });
});

// ========= 3. Base64 UUID 生成 =========
function generateBase64UUID() {
  const uuid = crypto.randomUUID().replace(/-/g, "");
  const bytes = Uint8Array.from(uuid.match(/.{2}/g).map((h) => parseInt(h, 16)));
  return btoa(String.fromCharCode(...bytes))
    .replace(/\+/g, "-")
    .replace(/\//g, "_")
    .replace(/=/g, "");
}

// ========= 4. URL変更検知 → ID再生成 =========
function getCurrentUrls() {
  return {
    url1: document.querySelector('[name="url1"]').value.trim(),
    url2: document.querySelector('[name="url2"]').value.trim(),
    url3: document.querySelector('[name="url3"]').value.trim(),
  };
}

function checkUrlUpdate() {
  const prev = JSON.parse(localStorage.getItem(DRAFT_URLS_KEY) || "{}");
  const now = getCurrentUrls();

  let changed = false;
  for (const k of ["url1","url2","url3"]) {
    if ((prev[k] || "") !== (now[k] || "")) changed = true;
  }

  if (changed) {
    // 新しいカタログ → ID再生成
    const newId = generateBase64UUID();
    localStorage.setItem(CATALOG_ID_KEY, newId);
    localStorage.setItem(DRAFT_URLS_KEY, JSON.stringify(now));
  }
}

// ========= 5. Make Webhook =========
const API_ITEMS_INPUT = "/api/items_input";

document.getElementById("giftForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const form = document.getElementById("giftForm");
  const data = Object.fromEntries(new FormData(form).entries());

  if (!data.title1 || !data.url1) {
    alert("商品1のタイトルとURLは必須です。");
    return;
  }

  // --- カタログID（無ければ生成） ---
  let catalogId = localStorage.getItem(CATALOG_ID_KEY);
  if (!catalogId) {
    catalogId = generateBase64UUID();
    localStorage.setItem(CATALOG_ID_KEY, catalogId);
  }

  // --- URLの個数 ---
  const urls = getCurrentUrls();
  const urlCount = Object.values(urls).filter(v => v && v !== "").length;
  localStorage.setItem("urlCount", urlCount);

  // --- URLセットの草稿を確定保存 ---
  localStorage.setItem(DRAFT_URLS_KEY, JSON.stringify(urls));

  const payload = {
    catalogId,
    urlCount,
    title1: data.title1, url1: data.url1,
    title2: data.title2 || "", url2: data.url2 || "",
    title3: data.title3 || "", url3: data.url3 || ""
  };

  try {
    const res = await fetch(API_ITEMS_INPUT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      alert("Make 連携でエラーが起きました。");
      return;
    }

    // ---- 次ページへ（URLパラメータ不要）----
    window.location.href = "giveselect.html";

  } catch (err) {
    console.error("fetch エラー:", err);
    alert("通信エラーが発生しました。");
  }
});
</script>

</body>
</html>
