<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ギフトを選んだ理由 | えらべるギフト</title>
<link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">

<style>
  :root{
    --pink:#f58fb1; --ink:#2a2a2a; --muted:#6b7280;
    --bg-top:#fff1f6; --bg-bottom:#fde9d3;
    --grad:linear-gradient(90deg,#f08db0 0%,#f2b35e 100%);
    --card-bg:#fff; --shadow:0 14px 30px rgba(0,0,0,.08); --radius:22px;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --vh:1svh;
    --screenH:calc(var(--vh) * 100);
  }

  *{box-sizing:border-box}
  html,body{min-height:100vh;height:auto}
  body{
    margin:0;
    font-family:"Kosugi Maru","Hiragino Maru Gothic ProN","Hiragino Sans","Noto Sans JP",system-ui,-apple-system;
    color:var(--ink);
    background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom)) fixed;
  }
  a{color:inherit;text-decoration:none}

  .wrap{
    max-width:960px;
    margin:0 auto;
    padding:16px 16px 0;
    min-height:var(--screenH);
    display:flex;
    flex-direction:column;
  }
  .main{flex:1;display:flex;flex-direction:column;}

  /* header */
  .header{display:flex;align-items:center;gap:12px;padding-top:4px;}
  .logo{width:32px;height:32px;display:flex;align-items:center;justify-content:center;}
  .brand{font-weight:800;font-size:22px;color:var(--pink);}

  /* title */
  .title{text-align:center;margin:26px 0 14px}
  h1{font-size:clamp(22px,6.2vw,32px);margin:8px 0 12px;}
  .lead{
    color:var(--muted);
    text-align:center;
    font-size:clamp(14px,2.3vw,16px);
  }

  /* カード */
  .cards{
    max-width:520px;
    width:92%;
    margin:0 auto 20px;
    display:flex;
    flex-direction:column;
    gap:16px;
  }

  .gift-card{
    background:#ffffff;
    border-radius:22px;
    box-shadow:0 12px 28px rgba(0,0,0,.06);
    padding:18px 18px 20px;
  }
  .gift-title{
    font-size:16px;
    font-weight:700;
    margin:0 0 6px;
  }
  .gift-sub{
    font-size:12px;
    color:var(--muted);
    margin:0 0 10px;
  }

  .reason-input{
    width:100%;
    min-height:76px;
    border-radius:14px;
    border:1px solid #e6dde0;
    padding:10px 12px;
    font-size:13px;
    resize:vertical;
    background:#fdfbfb;
  }

  .footer{
    padding:12px 8px calc(36px + var(--safe-bottom));
  }
  .row{display:flex;gap:12px}
  .btn{
    flex:1;padding:16px 20px;
    border-radius:14px;
    border:1px solid #eee;
    background:#fff;
  }
  .btn-prim{
    background:var(--grad);color:#fff;border:none;font-weight:800;
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- header -->
  <header class="header">
    <div class="logo">
      <svg viewBox="0 0 24 24" width="28" height="28" fill="none"
        stroke="var(--pink)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="8" width="18" height="12" rx="2"/>
        <path d="M12 8v12"/><path d="M3 12h18"/>
      </svg>
    </div>
    <div class="brand">えらべるギフト</div>
  </header>

  <!-- main -->
  <main class="main">
    <section class="title">
      <h1>ギフトを選んだ理由</h1>
      <p class="lead">贈りものに込めた気持ちを書いてください。</p>
    </section>

    <section class="cards">

      <!-- 3つの商品が localStorage の内容で書き換わる -->
      <article class="gift-card">
        <h2 id="title1" class="gift-title"></h2>
        <p class="gift-sub">このギフトを選んだ理由（任意）</p>
        <textarea id="reason1" class="reason-input"
        placeholder="例）寒がりなあの人が、冬でもあたたかく過ごせるように。"></textarea>
      </article>

      <article class="gift-card">
        <h2 id="title2" class="gift-title"></h2>
        <p class="gift-sub">このギフトを選んだ理由（任意）</p>
        <textarea id="reason2" class="reason-input"
        placeholder="例）仕事でもお出かけでも使いやすそうだと思ったから。"></textarea>
      </article>

      <article class="gift-card">
        <h2 id="title3" class="gift-title"></h2>
        <p class="gift-sub">このギフトを選んだ理由（任意）</p>
        <textarea id="reason3" class="reason-input"
        placeholder="例）これからの時間を一緒に大切にしていきたい想いを込めて。"></textarea>
      </article>

    </section>
  </main>

  <!-- footer -->
  <footer class="footer">
    <div class="row">
      <button class="btn" id="backBtn">戻る</button>
      <button class="btn btn-prim" id="nextBtn">次へ</button>
    </div>
  </footer>
</div>

<script>
/* ===== URL パラメータ保持セットアップ ===== */
    const srcParams = new URLSearchParams(location.search);

    // ここで引き継ぎたいキーを指定（必要に応じて増減OK）
    const KEEP = ["id","preview","egift"];

    // 遷移先URLを生成する関数
    function buildUrl(nextPage){
    const sp = new URLSearchParams();
    KEEP.forEach(k=>{
        if(srcParams.has(k)){
        sp.set(k, srcParams.get(k));
        }
    });
    const qs = sp.toString();
    return qs ? `${nextPage}?${qs}` : nextPage;
    }


  /* ===== iOS 高さ調整 ===== */
  function setVH(){
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', vh + 'px');
  }
  setVH();
  window.addEventListener('resize', setVH, {passive:true});
  window.addEventListener('orientationchange', setVH);

  /* ===== localStorage 読み込み ===== */
  const FORM_KEY = "giftDraft_v1";
  let draft = {};
  try{
    const raw = localStorage.getItem(FORM_KEY);
    if(raw) draft = JSON.parse(raw) || {};
  }catch(e){
    draft = {};
  }

  function getTitleForIndex(i){
    // 1. confirm.html などで入れている title1〜3 を最優先
    const legacy = draft["title"+i];
    if(typeof legacy === "string" && legacy.trim()){
      return legacy.trim();
    }

    // 2. perUrl の title をインデックス順で参照（念のため）
    const perUrl = draft.perUrl || {};
    const keys = Object.keys(perUrl);
    const key = keys[i-1];
    if(key && typeof perUrl[key].title === "string" && perUrl[key].title.trim()){
      return perUrl[key].title.trim();
    }

    // 3. どれも無ければデフォルト
    return "商品 " + i;
  }

  /* 商品名を反映 */
  function loadTitles(){
    for(let i=1;i<=3;i++){
      const el = document.getElementById("title"+i);
      if(!el) continue;
      el.textContent = getTitleForIndex(i);
    }
  }
  loadTitles();

  /* ===== 理由の保存 ===== */
  function saveReasons(){
    draft.reasons = {
      reason1: document.getElementById("reason1").value,
      reason2: document.getElementById("reason2").value,
      reason3: document.getElementById("reason3").value,
    };
    try{
      localStorage.setItem(FORM_KEY, JSON.stringify(draft));
    }catch(e){
      console.error("localStorage save error", e);
    }
  }

  const r1 = document.getElementById("reason1");
  const r2 = document.getElementById("reason2");
  const r3 = document.getElementById("reason3");

  r1.addEventListener("input", saveReasons);
  r2.addEventListener("input", saveReasons);
  r3.addEventListener("input", saveReasons);

  /* 保存済みなら復元 */
  if(draft.reasons){
    r1.value = draft.reasons.reason1 || "";
    r2.value = draft.reasons.reason2 || "";
    r3.value = draft.reasons.reason3 || "";
  }

  /* ボタン */
  /* 戻る */
    document.getElementById("backBtn").onclick = ()=>{
    if (document.referrer) {
        history.back();
    } else {
        window.location.href = buildUrl("message.html");
    }
    };

    /* 次へ（パラメータ引き継ぎ） */
    document.getElementById("nextBtn").onclick = ()=>{
    saveReasons();
    window.location.href = buildUrl("selectdesign.html");
    };

</script>

</body>
</html>
